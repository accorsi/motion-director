<!DOCTYPE html>
<html>
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400&display=swap" rel="stylesheet">
<style>
  /* --- 1. COLOR PALETTE & FONT --- */
  :root {
    --color-bg-darker: rgb(12, 14, 13, 0.10);
    --color-bg-dark: hsl(160, 6%, 9%, 0.10);
    --color-bg-medium: hsl(160, 4%, 14%, 0.2);
    --color-bg-regular: hsl(160, 4%, 18%, 0.4);
    --color-bg-light: hsl(160, 4%, 22%, 0.6); 
    --color-text-main: hsl(160, 6%, 91%, 0.80); 
    --color-text-faded: hsla(168, 5%, 81%, 0.617); 
    --color-accent-blue: #007AFF; 
    --color-accent-orange: hsl(42, 100%, 52%);
    --color-accent-orange-hover: hsl(42, 100%, 62%); 
    --color-accent-red: #FF3B30; 
    --color-accent-green: #12d067;
    --color-accent-green-hover: #0aef71;
    --color-accent-green-faded: #0aef7190;
    --color-border: #00000000;

    --font-main: 'Geist Mono', monospace; 
    --font-size-base: 10px; 
    --font-size-small: 9px;
    --font-size-tiny: 8px;

    --shadow-inner-light: inset 0 .75px 0px rgba(255, 255, 255, 0.1);
    --shadow-inner-lighter: inset 0 .75px 0px rgba(255, 255, 255, 0.35);
    --shadow-outer-white: 0 -.75px rgba(255,255,255,.6);
    --shadow-drop: 0 .75px 0px rgba(0, 0, 0, 0.5); 
    --shadow-inner-dark: inset 0 .75px 0px rgba(0, 0, 0, 0.5);
    --shadow-drop-big: 0 1px 0px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.25), 0 4px 8px rgba(0, 0, 0, 0.125), 0 8px 16px rgba(0, 0, 0, 0.0625);
    --shadow-inner-active: inset 0 0 0px .75px var(--color-accent-green-hover);

    --radius-small: 2px;
    --radius-medium: 4px;
    --radius-large: 8px;

    --spacing-xxs: 2px;
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-base: 16px;
    --spacing-md: 24px;
    --spacing-lg: 32px;
    --spacing-xl: 48px;
    --spacing-xxl: 64px;

  }

  /* --- 2. CORE BAR STYLES --- */
  body { 
      font-family: var(--font-main); 
      font-size: var(--font-size-base);
      padding: 0; margin: 0; 
      background-color: #0a0b0a; /* Very dark base */
      background-image: url('noise-texture.png');
      background-repeat: repeat;
      background-blend-mode: screen; /* Screen blend for grainy look */
      color: var(--color-text-main); 
      overflow: hidden; 
      transition: width 0.5s ease-out, height 0.5s ease-out, position 0.5s ease-out; 
      font-weight: 400;
  }

  /* --- 3. HEADER/CONTROL LAYOUT --- */
  header { 
      display: flex; justify-content: space-between; align-items: left; 
      padding: 4px; 
      height: 32px; box-sizing: content-box; 
      background: transparent; /* Let noise texture show through */
      z-index: 10; 
      position: relative;
      gap: 4px;
      transition: width 0.5s ease-out, height 0.5s ease-out; 
  }

  .controls-left { 
      display: flex; 
      flex-direction: row; 
      gap: 4px; 
      width: 100%;
      padding-top: 0px;
      align-items: center;
      transition: position 0.25s ease-out, width 0.25s ease-out; 
  }
  
  
  /* Shared Buttons */
  .btn-action { 
      border: none; 
      border-radius: var(--radius-large); 
      font-weight: 400; 
      cursor: pointer; 
      user-select: none;
      transition: 0.15s; 
      height: 32px; 
      line-height: 1; 
      box-sizing: border-box;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-family: var(--font-main); 
      white-space: nowrap; 
      flex-shrink: 0; 
      text-transform: uppercase;
      letter-spacing: 0.05em;
      /* Inset shadows for depth */
      box-shadow: 
          inset 0 1px 0 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 0 rgba(0,0,0,0.3),
          0 1px 2px rgba(0,0,0,0.3);
      font-size: var(--font-size-small); 
      /* Noise texture */
      background-image: url('noise-texture.png');
      background-blend-mode: overlay;
  }
  
  /* 3.1. CAPTURE Button - Orange/Yellow text */
  #btn-capture { 
      background-color: rgba(30, 32, 30, 0.9); /* Semi-transparent for texture */
      color: var(--color-accent-orange); 
      padding: 0 10px; 
  }
  #btn-capture:hover { 
      background-color: rgba(45, 47, 45, 0.3); 
  }

  /* 3.2. NAVIGATION Arrows - Dark Buttons */
  .nav-arrows-group { 
      display: flex; 
  }
  .nav-arrows-group button {
      background: var(--color-bg-medium); 
      color: var(--color-text-main);
      padding: 0;
      width: 28px;
  }
  #btn-play-previous {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
  }
  #btn-play-next {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
  }
  .nav-arrows-group button:hover { 
      background-color: rgba(45, 47, 45, 0.3);
  }
  
  /* 3.3. PLAY Button - Green text with white inner glow */
  #btn-play-all { 
      background-color: var(--color-bg-medium); 
      color: var(--color-accent-green); 
      padding: 0 10px;
      font-size: var(--font-size-small); 
      transition: 0.15s;
      /* White inner glow on text */
      text-shadow: 0 0 4px rgba(255,255,255,0.3);
  }
  #btn-play-all:hover { 
      background-color: rgba(45, 47, 45, 0.3);
  }
  
  /* STOP BUTTON - Red when playing */
  .btn-stop {
      background-color: var(--color-accent-red) !important;
      color: var(--color-text-main) !important;
  }
  .btn-stop:hover {
      background-color: #c9342c !important; 
  }

  /* 3.4. HIDE PATHS Button */
  #btn-hide-paths {
      background-color: var(--color-bg-medium); 
      color: var(--color-text-main); 
      padding: 0 9px;
  }
  #btn-hide-paths:hover { 
      background-color: rgba(45, 47, 45, 0.3); 
  }

  
  /* 3.5. UTILITY Buttons (Toggle/Settings) */
  .utility-buttons-group {
      display: flex;
      gap: 4px;
  }

  .utility-buttons-group button {
      background: var(--color-bg-medium); 
      color: var(--color-text-main); /* Ensure white/light text color */
      width: 32px; height: 32px; 
      padding: 0;
      font-size: 16px;
      border-radius: var(--radius-large); /* Ensure border radius */
  }
  .utility-buttons-group button:hover { background-color: rgba(45, 47, 45, 0.3); }
  
  /* Specific overrides to ensure they stay dark */
  #btn-toggle-mode, #btn-settings {
      background-color: var(--color-bg-medium);
      color: var(--color-text-main);
      width: 32px;
      height: 32px;
      &:hover { background-color: rgba(45, 47, 45, 0.3); }
  }

  .mode-vertical #btn-toggle-mode {
      width: 100%;
  }
  
  #btn-toggle-mode svg, #btn-settings svg {
      stroke: currentColor; /* Ensure SVGs use the text color */
  }

  #btn-clear-scenes {
      background: var(--color-accent-red); 
      color: var(--color-text-main); 
      padding: 0 12px;
      text-shadow: var(--shadow-outer-white);
      box-shadow: var(--shadow-inner-lighter);
  }
  #btn-clear-scenes:hover { background: var(--color-accent-red-hover); }
  
  /* --- 4. MODE-SPECIFIC STYLES --- */
  
  /* VERTICAL (Mini/Sidebar) Mode */
  .mode-vertical header { 
      flex-direction: column; 
      justify-content: flex-start;
      gap: 2px;
      height: 100%; 
      padding: 4px;
  }
  .mode-vertical .controls-left { 
      display: flex; 
      flex-direction: column; 
      gap: 2px; 
      width: 100%; 
      align-items: center;
      transition: width 0.3s ease-in-out, height 0.3s ease-in-out; 
  }
  
  /* Compact Button Styling for 72px width */
  .mode-vertical .btn-action { 
      width: 100%; 
      font-size: var(--font-size-small);
      padding: 0 4px;
      height: 32px; 
      border-radius: 8px;
  }
  
  /* Navigation Arrows in Vertical Mode */
  .mode-vertical .nav-arrows-group { 
      flex-direction: row; 
      justify-content: center; 
      width: 100%; 
      gap: 2px; 
      margin: 0; 
      margin-bottom: 4px; 
  }
  .mode-vertical .nav-arrows-group button { 
      width: 50%; 
      height: 32px;
      border-radius: var(--radius-medium) !important;
      margin: 0;
      border-right: none !important;
  }
  
  .mode-vertical #btn-capture { order: -1; } 
  .mode-vertical #btn-play-all { margin-right: 0; } 
  .mode-vertical #btn-hide-paths { display: block; padding: 0 2px; width: 100%; } 
  
  /* Utility Group in Vertical Mode */
  .mode-vertical .utility-buttons-group { 
      order: 1; 
      display: flex; 
      justify-content: center; 
      width: 100%;
  }
  .mode-vertical .utility-buttons-group button { 
      width: 100%; 
      height: 32px;
      border-radius: var(--radius-large); 
      font-size: 8px;
  }
  
  /* --- 5. EXPANDED/SETTINGS PANEL --- */
  #expanded-panel { 
      overflow-y: hidden; 
      height: calc(100% - 40px);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
  }

  /* SCENE LIST View */
  #scene-list-view {
      display: flex; 
      flex-direction: column;
      height: 100%;
      flex: 1;
      overflow: hidden;
  }

  #scene-list-view .setting-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      overflow: hidden;
      padding: 0 !important; /* Override inline style */
  }

  /* CONFIG View */
  #config-view {
      display: none;
      flex-direction: column;
      gap: 16px;
  }

  h3 { 
      font-size: var(--font-size-base); 
      margin: 0 0 10px 0; 
      color: var(--color-text-faded); 
      font-weight: 400; 
      letter-spacing: 0.05em; 
      text-transform: uppercase;
  }
  .setting-group { margin-bottom: 10px; padding: 12px; 
      border-radius: var(--radius-large); 
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); 
  }
  
  /* --- Scene List Styling --- */
  #scene-list { 
      list-style: none;
      overflow-y: auto; 
      overflow-x: hidden;
      display: flex;
      flex-flow: column;
      gap: 4px;
      flex: 1;
      padding: 4px;
  }
  .scene-item { 
      background-color: rgba(30, 32, 30, 0.6); /* Semi-transparent for texture */
      padding: 8px 10px; 
      border-radius: var(--radius-large); 
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: 0.2s;
      opacity: 0.5; /* Inactive cards at 60% */
      /* Inset shadows for depth */
      box-shadow: 
          inset 0 1px 0 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 0 rgba(0,0,0,0.4),
          0 1px 3px rgba(0,0,0,0.3);
  }
  .scene-item:hover {
      opacity: 0.9;
      background-color: rgba(45, 47, 45, 0.3);
  }

  .scene-item-active {
      background-color: rgba(20, 22, 20, 0.9); /* Darker, more opaque */
      opacity: 1; /* Full opacity when active */
      box-shadow: 
          inset 0 0 4px -1px var(--color-accent-green-faded),
          inset 0 1px 0 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 0 rgba(0,0,0,0.4),
          0 1px 3px rgba(0,0,0,0.3);
          &:hover {
              opacity: 1;
          }
  }

  .scene-top-row { display: flex; justify-content: space-between; align-items: center; gap: 4px; }

  /* Scene Name Input */
  .scene-name-input { 
      background: none; 
      border: none; 
      color: var(--color-text-main); 
      font-weight: 400; 
      font-size: var(--font-size-base); 
      padding: 2px 0;
      flex: 1 1 auto;
      min-width: 60px;
      max-width: 140px; /* Prevent overlap with buttons */
  }
  .scene-name-input:focus {
      outline: none;
      background: var(--color-bg-dark); 
      padding: 2px 4px;
      border-radius: var(--radius-small);
      box-shadow: 0 0 0 1px var(--color-accent-green); /* Green focus ring */
  }
  
  /* Scene Action Buttons */
  .scene-top-row .actions button { 
      background: none; border: none; color: var(--color-text-faded); 
      font-size: var(--font-size-tiny); 
      cursor: pointer; padding: 2px 4px; transition: color 0.2s; 
  }
  .scene-top-row .actions button:hover { color: var(--color-text-main); }

  /* Path Toggle Wrapper with Popup */
  .path-toggle-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
  }
  
  .path-controls-popup {
    position: absolute;
    right: 24px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
    margin-left: 0;
    z-index: 10;
  }
  
  .path-controls-popup .btn-visualize {
      font-size: var(--font-size-tiny);
      padding: 2px 4px;
      margin: 0;
      text-transform: uppercase;
      white-space: nowrap;
  }


  /* Control Inputs (Duration, Delay, Easing) */
  .scene-edit-row { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; justify-content: space-between;}
  .bezier-row { margin-top: var(--spacing-sm); display: flex; align-items: center; justify-content: space-between;}
  
  label { 
      font-size: var(--font-size-tiny); 
      color: var(--color-text-faded); 
      text-transform: uppercase; 
      margin-right: 6px; 
      letter-spacing: -0.01em; 
      font-weight: 400;
      text-shadow: var(--shadow-inner-dark);
  }
  .control-group { display: flex; align-items: center; }
  
  /* Input/Select Consistency */
  .control-group input[type="number"],
  .control-group select {
      background: var(--color-bg-dark); color: var(--color-text-main); border: 1px solid var(--color-border); 
      padding: 4px;
      height: 24px;
      width: 40px;
      box-sizing: border-box;
      border-radius: var(--radius-small); font-size: var(--font-size-tiny); 
      text-align: right; appearance: none; -moz-appearance: textfield;
      font-family: var(--font-main);
      font-weight: 400;
  }
  .control-group select {
      width: 88px;
      text-align: left;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='8' height='4' viewBox='0 0 8 4' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0.5 0.5L4 3.5L7.5 0.5' stroke='%23888888' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 16px;
      height: 24px;
  }
  
  /* Hide Number Spinners */
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
  }

  /* Drag Handle */
  .drag-handle {
      cursor: grab;
      color: var(--color-text-faded);
      display: flex;
      align-items: center;
      margin-right: 8px;
  }
  .drag-handle:active {
      cursor: grabbing;
  }
  .scene-item.dragging {
      opacity: 0.5;
      border: .75px dashed var(--color-text-faded);
  }
  
  .bezier-row input[type="text"] {
      flex-grow: 1; padding: 6px; 
      background: var(--color-bg-dark); color: var(--color-text-main); border: 1px solid var(--color-border); 
      border-radius: var(--radius-medium); font-size: var(--font-size-small); font-family: var(--font-main); text-align: left;
      height: 24px;
      box-sizing: border-box;
      font-weight: 400;
  }
  
  /* Visualize Path Button Row */
  .scene-actions-bottom { 
      display: flex; justify-content: space-between; 
      margin-top: 10px; 
      border-top: 1px solid var(--color-border); 
      padding-top: 8px; 
  }
  .btn-visualize { 
      background: var(--color-bg-medium);
      color: var(--color-text-faded);
      padding: 4px 6px;
      font-size: var(--font-size-tiny);
      font-weight: 400;
      cursor: pointer;
      border-radius: var(--radius-small);
      transition: background 0.3s;
      font-family: var(--font-main);
  }
  .btn-visualize:hover {
      background: #333;
  }
  
  .btn-recalculate {
      border: 1px solid var(--color-border);
      background: var(--color-bg-medium);
      color: var(--color-text-faded);
  }
  .btn-recalculate:hover {
      background: #333;
  }

  /* Project Manager styles */
  .project-manager input,
  .project-buttons button {
      font-size: var(--font-size-small); 
      font-weight: 400;
  }
  .project-manager input {
      padding: 6px;
      height: 30px;
      box-sizing: border-box;
      background: var(--color-bg-light);
      border: 1px solid var(--color-border);
      color: var(--color-text-main);
      border-radius: var(--radius-medium);
      width: 100%;
      margin-bottom: 8px;
      font-family: var(--font-main);
  }
  .project-buttons {
      display: flex;
      gap: 8px;
      justify-content: space-between;
  }
  .project-buttons button {
      background: var(--color-bg-dark);
      color: var(--color-text-main);
      border: 1px solid var(--color-border);
      padding: 6px 12px;
      border-radius: var(--radius-large);
      cursor: pointer;
      transition: background 0.2s;
      flex-grow: 1;
      font-family: var(--font-main);
  }
  .project-buttons button:hover {
      background: #282828;
  }

  /* General Settings */
  .size-controls {
      display: flex;
      gap: 16px;
      margin-top: 10px;
  }
  .control-group input[type="number"] {
      text-align: left;
      padding: 4px 8px;
  }
  #plugin-mode-select {
      width: 100%;
      text-align: left;
      padding: 4px 8px;
      height: 30px;
  }

  #arc-enabled-checkbox + label {
      font-size: var(--font-size-base); 
      color: var(--color-text-main); 
      text-transform: none;
      margin: 0;
  }

  /* Hidden elements */
  .hidden-icons {
      display: none;
  }

  #expanded-panel.collapsed {
      display: none;
  }

  /* Scene list container specific overrides */
  #scene-list-view .setting-group {
      margin-bottom: 0;
      padding: 12px 12px 2px 12px;
  }

  /* Empty State */
  .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xl) var(--spacing-base);
      text-align: center;
      min-height: 200px;
  }

  .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-base);
      opacity: 0.3;
  }

  .empty-state-title {
      font-size: var(--font-size-base);
      font-weight: 600;
      color: var(--color-text-main);
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }

  .empty-state-message {
      font-size: var(--font-size-small);
      color: var(--color-text-faded);
      margin-bottom: var(--spacing-base);
      max-width: 300px;
  }

  .empty-state-cta {
      background: var(--color-accent-green);
      color: var(--color-bg-dark);
      padding: var(--spacing-xs) var(--spacing-base);
      border: none;
      border-radius: var(--radius-large);
      font-family: var(--font-main);
      font-size: var(--font-size-small);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: 0.15s;
      box-shadow: var(--shadow-inner-lighter);
      text-shadow: var(--shadow-outer-white);
  }

  .empty-state-cta:hover {
      background: var(--color-accent-green-hover);
  }

  /* Loading Overlay */
  .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(2px);
  }

  .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-bg-medium);
      border-top: 3px solid var(--color-accent-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--spacing-base);
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .loading-message {
      color: var(--color-text-main);
      font-size: var(--font-size-small);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }

  /* Config view specific styles */
  #config-view .control-group.plugin-mode {
      margin-bottom: 10px;
  }

  #config-view .control-group.plugin-mode label {
      margin-right: 8px;
  }

  #config-view .checkbox-group {
      margin-top: 10px;
  }

</style>
</head>
<body class="mode-horizontal">

<header>
    <div class="controls-left">
        <button id="btn-capture" class="btn-action">Capture</button>
        
        <div class="nav-arrows-group">
            <button id="btn-play-previous" class="btn-action" title="Animate to Previous Scene">
                <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g filter="url(#filter0_d_2264_5655)">
                    <path d="M3.875 7.375L0.375 3.875L3.875 0.375" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                    </g>
                    <defs>
                    <filter id="filter0_d_2264_5655" x="0" y="0" width="4.25" height="8.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                    <feOffset dy="0.5"/>
                    <feComposite in2="hardAlpha" operator="out"/>
                    <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
                    <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5655"/>
                    <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5655" result="shape"/>
                    </filter>
                    </defs>
                    </svg>
            </button>
            <button id="btn-play-next" class="btn-action" title="Animate to Next Scene">
                <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g filter="url(#filter0_d_2264_5658)">
                    <path d="M0.375 7.375L3.875 3.875L0.375 0.375" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                    </g>
                    <defs>
                    <filter id="filter0_d_2264_5658" x="0" y="0" width="4.25" height="8.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                    <feOffset dy="0.5"/>
                    <feComposite in2="hardAlpha" operator="out"/>
                    <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
                    <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5658"/>
                    <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5658" result="shape"/>
                    </filter>
                    </defs>
                    </svg>
            </button>
        </div>
        
        <button id="btn-play-all" class="btn-action">Play</button>
        
        <button id="btn-hide-paths" class="btn-action" title="Hide all path visualizations in Figma">Hide Paths</button>
    </div>
    
        <button id="btn-toggle-mode" class="btn-action" title="Toggle Plugin Mode">
            <span id="mode-icon-span"></span>
        </button>
        <button id="btn-settings" class="btn-action" title="Settings/Scene List">
            <svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#filter0_d_2264_5571_static)">
                <path d="M6.675 6.164L3.875 1.313M6.675 8.586L3.875 13.437M7.375 14.375V12.975M7.375 12.975C10.4678 12.975 12.975 10.4678 12.975 7.375C12.975 4.28221 10.4678 1.775 7.375 1.775M7.375 12.975C4.28221 12.975 1.775 10.4678 1.775 7.375M7.375 0.375V1.775M7.375 1.775C4.28221 1.775 1.775 4.28221 1.775 7.375M8.775 7.375H14.375M8.775 7.375C8.775 8.1482 8.1482 8.775 7.375 8.775C6.6018 8.775 5.975 8.1482 5.975 7.375C5.975 6.6018 6.6018 5.975 7.375 5.975C8.1482 5.975 8.775 6.6018 8.775 7.375ZM10.875 13.437L10.175 12.226M10.875 1.313L10.175 2.524M0.375 7.375H1.775M13.437 10.875L12.226 10.175M13.437 3.875L12.226 4.575M1.313 10.875L2.524 10.175M1.313 3.875L2.524 4.575" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                </g>
                <defs>
                <filter id="filter0_d_2264_5571_static" x="0" y="0" width="14.75" height="15.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                <feOffset dy="0.5"/>
                <feComposite in2="hardAlpha" operator="out"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5571"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5571" result="shape"/>
                </filter>
                </defs>
            </svg>
        </button>
    </div>
</header>

<div class="hidden-icons">
    <!-- Icon for Minify (Collapse) - Used in Horizontal Mode -->
    <svg id="icon-minify" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_2264_5581_min)">
        <path d="M6.79167 4.45833L10.875 0.375M6.79167 4.45833H10.2917M6.79167 4.45833V0.958333M0.375 10.875L4.45833 6.79167M4.45833 6.79167H0.958333M4.45833 6.79167V10.2917" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
        </g>
        <defs>
        <filter id="filter0_d_2264_5581_min" x="0" y="0" width="11.25" height="11.75" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dy="0.5"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5581_min"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5581_min" result="shape"/>
        </filter>
        </defs>
    </svg>
    
    <!-- Icon for Expand - Used in Vertical Mode -->
    <svg id="icon-expand" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M8.75 8.75L12.25 12.25M12.25 12.25V9.33333M12.25 12.25H9.33333M8.75 5.25L12.25 1.75M12.25 1.75V4.66667M12.25 1.75H9.33333M1.75 9.33333V12.25M1.75 12.25H4.66667M1.75 12.25L5.25 8.75M1.75 4.66667V1.75M1.75 1.75H4.66667M1.75 1.75L5.25 5.25" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>

    
    <svg id="icon-settings" width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_2264_5571_clone)">
        <path d="M6.675 6.164L3.875 1.313M6.675 8.586L3.875 13.437M7.375 14.375V12.975M7.375 12.975C10.4678 12.975 12.975 10.4678 12.975 7.375C12.975 4.28221 10.4678 1.775 7.375 1.775M7.375 12.975C4.28221 12.975 1.775 10.4678 1.775 7.375M7.375 0.375V1.775M7.375 1.775C4.28221 1.775 1.775 4.28221 1.775 7.375M8.775 7.375H14.375M8.775 7.375C8.775 8.1482 8.1482 8.775 7.375 8.775C6.6018 8.775 5.975 8.1482 5.975 7.375C5.975 6.6018 6.6018 5.975 7.375 5.975C8.1482 5.975 8.775 6.6018 8.775 7.375ZM10.875 13.437L10.175 12.226M10.875 1.313L10.175 2.524M0.375 7.375H1.775M13.437 10.875L12.226 10.175M13.437 3.875L12.226 4.575M1.313 10.875L2.524 10.175M1.313 3.875L2.524 4.575" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
        </g>
        <defs>
        <filter id="filter0_d_2264_5571_clone" x="0" y="0" width="14.75" height="15.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dy="0.5"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5571"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5571" result="shape"/>
        </filter>
        </defs>
    </svg>
</div>
<div id="expanded-panel" class="collapsed">
    
    <div id="scene-list-view">
        <div class="setting-group">
            <div id="scene-list"></div>
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ðŸ“¹</div>
                <div class="empty-state-title">No Scenes Yet</div>
                <div class="empty-state-message">Start by capturing your first scene to create a camera animation sequence.</div>
                <button class="empty-state-cta" onclick="document.getElementById('btn-capture').click()">Capture First Scene</button>
            </div>
        </div>
    </div>
    
    <div id="config-view">
        <div class="setting-group">
            <h3>Project Manager</h3>
            <div class="project-manager">
                <input type="text" id="project-name-input" value="Default Project" placeholder="Enter Project Name">
                <div class="project-buttons">
                    <button id="btn-save-project">Save Project</button>
                    <button id="btn-load-project">Load Project</button>
                    <button id="btn-clear-scenes">Clear All Scenes</button>
                </div>
                <div style="margin-top: 8px; display: flex; justify-content: flex-end;">
                    <button id="btn-toggle-theme" class="btn-visualize" style="width: auto;">Toggle Theme ðŸŒ“</button>
                </div>
            </div>
        </div>
    
        <div class="setting-group">
            <h3>General Settings</h3>
            
            <div class="control-group plugin-mode">
                <label for="plugin-mode-select">Plugin Mode</label>
                <select id="plugin-mode-select">
                    <option value="horizontal">Wide/Horizontal (Screen Recording)</option>
                    <option value="vertical">Mini/Vertical (Sidebar)</option>
                </select>
            </div>

            <div class="size-controls">
                <div class="control-group">
                    <label>Wide Width</label>
                    <input type="number" id="default-width-input" min="335" max="1000" value="335">
                </div>
                <div class="control-group">
                    <label>Wide Height</label>
                    <input type="number" id="default-height-input" min="300" max="1000" value="400">
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="arc-enabled-checkbox">
                <label for="arc-enabled-checkbox">Enable Arc Path (Curved Camera Move)</label>
            </div>
        </div>
    </div>

</div>

<script>
  let scenes = [];
  let currentSceneIndex = 0; 
  let pluginMode = 'horizontal'; 
  let currentView = 'collapsed'; // Initial state should be 'collapsed'
  let is_playing = false; // Flag to track if the "Play All" sequence is running
  let animation_frame_id = null; // Holds the requestAnimationFrame ID for cancellation
// ----------------------------------
  
  let defaultWideWidth = 335;
  let defaultWideHeight = 400; 
  let isArcEnabled = true;

  let currentProjectName = 'motionDirectorDefaultProject';
  const DEFAULT_PROJECT_KEY = 'motionDirectorDefaultProject';

  const HORIZONTAL_MIN_HEIGHT = 40; 
  const VERTICAL_MINI_WIDTH = 72; 
  const VERTICAL_MINI_HEIGHT = 182; 
  
  const NEWTON_ITERATIONS = 4;
  const NEWTON_MIN_TOLERANCE = 0.001;
  const MID_ARC_FACTOR = 0.05; 
  
  // --- 1. CORE MATH FUNCTIONS ---
  function A(aA1, aA2) { return 1.0 - 3.0 * aA2 + 3.0 * aA1; }
  function B(aA1, aA2) { return 3.0 * aA2 - 6.0 * aA1; }
  function C(aA1)      { return 3.0 * aA1; }
  function CalcBezier(aA1, aA2, aT) { return ((A(aA1, aA2) * aT + B(aA1, aA2)) * aT + C(aA1)) * aT; }
  function GetSlope(aA1, aA2, aT) { return 3.0 * A(aA1, aA2) * aT * aT + 2.0 * B(aA1, aA2) * aT + C(aA1); }
  function GetTForX(aX, aA1, aA2) {
      let aGuessT = aX;
      for (let i = 0; i < NEWTON_ITERATIONS; ++i) {
          const currentX = CalcBezier(aA1, aA2, aGuessT) - aX;
          if (Math.abs(currentX) < NEWTON_MIN_TOLERANCE) return aGuessT;
          const currentSlope = GetSlope(aA1, aA2, aGuessT);
          if (Math.abs(currentSlope) < NEWTON_MIN_TOLERANCE) return aGuessT;
          aGuessT -= currentX / currentSlope;
      }
      return aGuessT;
  }
  function cubicBezier(t, x1, y1, x2, y2) {
      if (t === 0 || t === 1) return t;
      return CalcBezier(y1, y2, GetTForX(t, x1, x2));
  }
  function getEasing(t, easing, bezierPoints) {
    if (easing === 'custom' && bezierPoints && bezierPoints.length === 4) {
        const [x1, y1, x2, y2] = bezierPoints;
        const cx1 = Math.max(0, Math.min(1, parseFloat(x1)));
        const cy1 = parseFloat(y1);
        const cx2 = Math.max(0, Math.min(1, parseFloat(x2)));
        const cy2 = parseFloat(y2);
        return cubicBezier(t, cx1, cy1, cx2, cy2);
    }
    
    // Easing presets using cubic-bezier curves
    // Note: Avoid extreme overshoot values for camera - they cause shaking
    switch (easing) {
      // Original presets - smooth and safe
      case 'snap': return 1 - Math.pow(1 - t, 4); 
      case 'smooth': return cubicBezier(t, 0.25, 0.1, 0.25, 1);
      case 'linear': return t;
      
      // Standard CSS-like easings - safe for camera
      case 'ease': return cubicBezier(t, 0.25, 0.1, 0.25, 1);
      case 'ease-in': return cubicBezier(t, 0.42, 0, 1, 1);
      case 'ease-out': return cubicBezier(t, 0, 0, 0.58, 1);
      case 'ease-in-out': return cubicBezier(t, 0.42, 0, 0.58, 1);
      
      // Gentle back easings (minimal overshoot - safer for camera)
      case 'ease-in-back': return cubicBezier(t, 0.6, -0.1, 0.735, 0.045);
      case 'ease-out-back': return cubicBezier(t, 0.175, 0.885, 0.32, 1.1);
      case 'ease-in-out-back': return cubicBezier(t, 0.68, -0.2, 0.265, 1.2);
      
      // Exponential easings - dramatic but safe
      case 'ease-in-expo': return cubicBezier(t, 0.95, 0.05, 0.795, 0.035);
      case 'ease-out-expo': return cubicBezier(t, 0.19, 1, 0.22, 1);
      
      // Circular easings - smooth curves
      case 'ease-in-circ': return cubicBezier(t, 0.6, 0.04, 0.98, 0.335);
      case 'ease-out-circ': return cubicBezier(t, 0.075, 0.82, 0.165, 1);
      
      // Spring - gentler bounce
      case 'spring': return cubicBezier(t, 0.175, 0.885, 0.32, 1.05);
      
      default: return t;
    }
  }


  function quadraticBezier(t, p0, p1, p2) {
      const oneMinusT = 1 - t;
      return oneMinusT * oneMinusT * p0 + 2 * oneMinusT * t * p1 + t * t * p2;
  }

  const MAX_ARC_OFFSET = 2000;

  function calculateArcControlPoint(start, end) {
      const dx = end.x - start.x;
      const dy = end.y - start.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      if (distance < 100) return { xc: (start.x + end.x) / 2, yc: (start.y + end.y) / 2 };

      const mx = (start.x + end.x) / 2;
      const my = (start.y + end.y) / 2;
      const nx = -dy;
      const ny = dx;
      const normLength = Math.sqrt(nx * nx + ny * ny);
      
      const calculatedOffset = distance * MID_ARC_FACTOR;
      const clampedOffset = Math.min(calculatedOffset, MAX_ARC_OFFSET);
      const scale = clampedOffset / normLength;

      const xc = mx + nx * scale;
      const yc = my + ny * scale;

      return { xc, yc };
  }


  // --- 2. PERSISTENCE & PROJECT MANAGEMENT ---

  function saveProject() {
      const dataToSave = {
          scenes: scenes,
          pluginMode: pluginMode,
          defaultWideWidth: defaultWideWidth,
          defaultWideHeight: defaultWideHeight,
          isArcEnabled: isArcEnabled,
          currentView: currentView // Save the current logical view state
      };
      parent.postMessage({ pluginMessage: { type: 'set-project', name: currentProjectName, data: dataToSave } }, '*');
  }

  function loadProject(projectName) {
      currentProjectName = (projectName.trim() || DEFAULT_PROJECT_KEY).replace(/[^a-zA-Z0-9]/g, '_');
      document.getElementById('project-name-input').value = currentProjectName;
      parent.postMessage({ pluginMessage: { type: 'get-project', name: currentProjectName } }, '*');
  }

  function initializeData(data, projectName) {
      currentProjectName = projectName;
      document.getElementById('project-name-input').value = projectName === DEFAULT_PROJECT_KEY ? "Default Project" : projectName;

      if (data) {
          if (data.scenes && Array.isArray(data.scenes)) {
              scenes = data.scenes;
              scenes.forEach((s, i) => {
                  if (!s.name || s.name.startsWith("Scene ")) {
                      s.name = `Scene ${i + 1}`;
                  }
                  if (!s.customControlPoint) {
                    s.customControlPoint = null;
                  }
              });
          }
          defaultWideWidth = data.defaultWideWidth || 335;
          defaultWideHeight = data.defaultWideHeight || 400;
          isArcEnabled = data.isArcEnabled !== undefined ? data.isArcEnabled : true;
          
          const modeToLoad = data.pluginMode || 'horizontal'; 
          
          document.getElementById('default-width-input').value = defaultWideWidth;
          document.getElementById('default-height-input').value = defaultWideHeight;
          document.getElementById('arc-enabled-checkbox').checked = isArcEnabled;
          document.getElementById('plugin-mode-select').value = modeToLoad; 
          
          // Set the mode which handles the initial sizing
          setMode(modeToLoad, false); 
          
          // NEW: Auto-expand logic (Targeted requirement)
          if (modeToLoad === 'horizontal') {
              // Always show scenes view (will show empty state if no scenes)
              setPluginView('scenes', false); 
          }
          // Note: Vertical mode is always handled as 'scenes' via setMode
          
          renderList();
      } else {
          scenes = [];
          defaultWideWidth = 335;
          defaultWideHeight = 400;
          isArcEnabled = true;
          setMode('horizontal', false); 
          setPluginView('scenes', false); // Show empty state if no data
          renderList();
      }
  }

  document.getElementById('project-name-input').onchange = (e) => {
    currentProjectName = (e.target.value.trim() || "Default Project").replace(/[^a-zA-Z0-9]/g, '_');
    e.target.value = currentProjectName;
  };

  document.getElementById('btn-save-project').onclick = () => {
    saveProject();
    alert(`Project "${currentProjectName}" saved!`);
  };

  document.getElementById('btn-load-project').onclick = () => {
    const name = document.getElementById('project-name-input').value;
    loadProject(name);
  };
  
  document.getElementById('btn-clear-scenes').onclick = () => {
    if (confirm("Are you sure you want to clear ALL scenes in the current session? This cannot be undone.")) {
      scenes = [];
      currentSceneIndex = 0; 
      renderList();
      saveProject();
      setPluginView('collapsed', true); // Collapse after clearing scenes
    }
  };


  // --- General Settings Handlers ---
  
  document.getElementById('default-width-input').onchange = (e) => {
      const newWidth = parseInt(e.target.value) || 335;
      defaultWideWidth = Math.max(335, Math.min(1000, newWidth));
      e.target.value = defaultWideWidth;
      saveProject(); 
      if (pluginMode === 'horizontal') {
           const height = (currentView === 'collapsed') ? HORIZONTAL_MIN_HEIGHT : defaultWideHeight;
           setPluginSize(defaultWideWidth, height);
      }
  };

  document.getElementById('default-height-input').onchange = (e) => {
      const newHeight = parseInt(e.target.value) || 400;
      defaultWideHeight = Math.max(300, Math.min(1000, newHeight));
      e.target.value = defaultWideHeight;
      saveProject(); 
      if (pluginMode === 'horizontal' && currentView !== 'collapsed') {
          setPluginSize(defaultWideWidth, defaultWideHeight);
      }
  };

  document.getElementById('arc-enabled-checkbox').onchange = (e) => {
      isArcEnabled = e.target.checked;
      saveProject(); 
  };
  
  document.getElementById('btn-hide-paths').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'hide-paths' } }, '*');
  };


  // --- 3. SCENE MANAGEMENT ---
  
  function parseBezierString(bezierString) {
      if (!bezierString) return [];
      return bezierString.split(',').map(s => s.trim()).filter(s => s.length > 0).map(parseFloat);
  }
  
  function handleUpdateScene(index, prop, value) {
      scenes[index][prop] = value;
      saveProject(); 
  }

  function handleUpdateSceneView(index) {
      // Send a request to capture the current view, but tag it with the index we want to update
      parent.postMessage({ pluginMessage: { type: 'capture-scene', updateIndex: index } }, '*');
  }
  
  function handlePlayScene(index) {
    if (is_playing) return; 
    
    if (scenes.length < 2) return;
    
    // Target scene is the one being played TO
    const targetScene = scenes[index]; 
    
    // Path settings are defined on the scene BEFORE the target scene in the sequence.
    const pathSettingsIndex = (index === 0) ? scenes.length - 1 : index - 1; 
    
    parent.postMessage({ pluginMessage: { type: 'capture-scene', targetScene: targetScene, pathSettingsIndex: pathSettingsIndex } }, '*');
    
    currentSceneIndex = index; // Set current index to the scene we just animated TO
    renderList(); // Refresh the list to apply the active class
}
  
  function handleDeleteScene(index) {
      if (confirm("Delete this scene?")) {
          // Delete the path associated with this scene
          parent.postMessage({ pluginMessage: { type: 'delete-scene-path', sceneIndex: index } }, '*');
          
          scenes.splice(index, 1); 
          if (currentSceneIndex >= scenes.length) {
              currentSceneIndex = scenes.length - 1; 
          }
          renderList();
          saveProject();
          
          if (scenes.length === 0) {
              setPluginView('scenes', true); // Show empty state
          }
      }
  }

  // --- 4. UI AND MODE CONTROL (FIXED/UPDATED) ---
  let targetViewPayload = null; 

  function setPluginSize(width, height) {
      document.body.style.width = `${width}px`;
      document.body.style.height = `${height}px`;
      parent.postMessage({ pluginMessage: { type: 'resize', width, height } }, '*');
  }

  /**
   * Toggles between Horizontal (Wide) and Vertical (Mini) Mode.
   */
  function setMode(mode, shouldSave = true) { 
      pluginMode = mode;
      document.body.className = `mode-${mode}`;
      
      const settingsButton = document.getElementById('btn-settings');
      const modeIconSpan = document.getElementById('mode-icon-span');
      
      if (mode === 'horizontal') {
          settingsButton.style.display = 'flex';
          // Horizontal Mode -> Show "Minimize" icon (to allow switching to Vertical)
          modeIconSpan.innerHTML = document.getElementById('icon-minify').outerHTML;

          // Explicitly set size based on the logical view state
          if (currentView === 'collapsed') {
             setPluginSize(defaultWideWidth, HORIZONTAL_MIN_HEIGHT);
             document.getElementById('expanded-panel').style.display = 'none';
          } else {
             setPluginSize(defaultWideWidth, defaultWideHeight);
             document.getElementById('expanded-panel').style.display = 'flex';
          }
      } else if (mode === 'vertical') {
          document.getElementById('expanded-panel').style.display = 'none'; // Vertical mode does not use the expanded panel
          settingsButton.style.display = 'none'; 
          currentView = 'scenes'; // Vertical mode is logically always focused on scenes
          setPluginSize(VERTICAL_MINI_WIDTH, VERTICAL_MINI_HEIGHT);
          
          // Vertical Mode -> Show "Expand" icon (to allow switching to Horizontal)
          modeIconSpan.innerHTML = document.getElementById('icon-expand').outerHTML;
      }
      
      document.getElementById('plugin-mode-select').value = mode;

      if (shouldSave) {
          saveProject(); 
      }
  }

  /**
   * Toggles between the Scene List View, Configuration View, or Collapsed state
   * and updates the plugin size and button icon. (UPDATED for icon change)
   */
  function setPluginView(viewName, shouldSave = true) {
      currentView = viewName;
      const expandedPanel = document.getElementById('expanded-panel');
      const sceneView = document.getElementById('scene-list-view');
      const configView = document.getElementById('config-view');
      const settingsButton = document.getElementById('btn-settings');
      const settingsIconSpan = document.getElementById('settings-icon');

      // 1. Logic for Collapsed State
      if (viewName === 'collapsed') {
          expandedPanel.style.display = 'none';
          settingsButton.style.color = 'var(--color-text-faded)'; 

          if (pluginMode === 'horizontal') {
              setPluginSize(defaultWideWidth, HORIZONTAL_MIN_HEIGHT); // Reset to collapsed size
          }
          
      } else {
          // 2. Logic for Expanded States ('scenes' or 'config')
          expandedPanel.style.display = 'flex'; 
          
          if (viewName === 'config') {
              sceneView.style.display = 'none';
              configView.style.display = 'flex';
              settingsButton.style.color = 'var(--color-accent-blue)'; 
              
          } else { // 'scenes' view
              sceneView.style.display = 'flex';
              configView.style.display = 'none';
              settingsButton.style.color = 'var(--color-text-faded)'; 
          }
          
          if (pluginMode === 'horizontal') {
              setPluginSize(defaultWideWidth, defaultWideHeight); // Ensure expanded size
          }
      }

      if (shouldSave) {
          saveProject();
      }
  }

  
  /**
   * Toggles the Expanded/Collapsed state (Horizontal Mode) or the View (Scene/Config).
   */
  document.getElementById('btn-settings').onclick = () => {
    if (pluginMode === 'vertical') return; // Settings button is hidden in vertical mode

    if (currentView === 'collapsed') {
        setPluginView('scenes'); // Collapsed -> Scenes
    } else if (currentView === 'scenes') {
        setPluginView('config'); // Scenes -> Config
    } else { // currentView === 'config'
        setPluginView('collapsed'); // Config -> Collapsed
    }
  };
  
  /**
   * Toggles between Horizontal (Wide) and Vertical (Mini) Mode.
   */
  document.getElementById('btn-toggle-mode').onclick = () => {
    const newMode = pluginMode === 'horizontal' ? 'vertical' : 'horizontal';
    setMode(newMode);
  };


  document.getElementById('plugin-mode-select').onchange = (e) => {
      setMode(e.target.value);
  };

  window.onload = () => {
      // Need to set the initial icon state before fetching data 
      // as fetching data is async and will call setPluginView
      // document.getElementById('settings-icon').innerHTML = document.getElementById('icon-expand').outerHTML; // REMOVED
      
      // Start with expanded panel showing scene list
      setPluginView('scenes');
      
      loadProject("Default Project");
  }


  // --- Path Visualization and Editing ---

  function getPathData(sceneIndex) {
    if (sceneIndex === scenes.length - 1 || scenes.length < 2) {
        return null;
    }

    const startScene = scenes[sceneIndex];
    const endScene = scenes[sceneIndex + 1];

    if (!startScene || !endScene) return null;

    const start = startScene.view;
    const end = endScene.view;
    
    let controlPoint = startScene.customControlPoint;

    if (!controlPoint) {
        const defaultControl = calculateArcControlPoint(start, end);
        controlPoint = { x: defaultControl.xc, y: defaultControl.yc };
    }

    return {
        start: { x: start.x, y: start.y },
        end: { x: end.x, y: end.y },
        control: controlPoint,
        isArcEnabled: isArcEnabled,
        isCustom: !!startScene.customControlPoint
    };
  }

  // ========================================
  // THEME SYSTEM
  // ========================================

  const themes = {
    dark: {
      '--color-bg-darker': 'hsl(160, 6%, 5%)',
      '--color-bg-dark': 'hsl(160, 6%, 9%)',
      '--color-bg-medium': 'hsl(160, 4%, 14%)',
      '--color-bg-regular': 'hsl(160, 4%, 18%)',
      '--color-bg-light': 'hsl(160, 4%, 22%)',
      '--color-text-main': 'hsl(160, 6%, 91%)',
      '--color-text-faded': 'hsla(168, 5%, 81%, 0.617)',
      '--color-border': '#00000000',
      '--shadow-inner-light': 'inset 0 .75px 0px rgba(255, 255, 255, 0.1)',
      '--shadow-inner-lighter': 'inset 0 .75px 0px rgba(255, 255, 255, 0.35)',
      '--shadow-outer-white': '0 -.75px rgba(255,255,255,.6)',
      '--shadow-drop': '0 .75px 0px rgba(0, 0, 0, 0.5)',
      '--shadow-inner-dark': 'inset 0 .75px 0px rgba(0, 0, 0, 0.5)',
      '--shadow-drop-big': '0 1px 0px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.25), 0 4px 8px rgba(0, 0, 0, 0.125), 0 8px 16px rgba(0, 0, 0, 0.0625)'
    },
    light: {
      '--color-bg-darker': 'hsl(0, 0%, 98%)',
      '--color-bg-dark': 'hsl(0, 0%, 95%)',
      '--color-bg-medium': 'hsl(0, 0%, 90%)',
      '--color-bg-regular': 'hsl(0, 0%, 85%)',
      '--color-bg-light': 'hsl(0, 0%, 80%)',
      '--color-text-main': 'hsl(0, 0%, 10%)',
      '--color-text-faded': 'hsla(0, 0%, 30%, 0.6)',
      '--color-border': 'hsl(0, 0%, 85%)',
      '--shadow-inner-light': 'inset 0 .75px 0px rgba(255, 255, 255, 0.5)',
      '--shadow-inner-lighter': 'inset 0 .75px 0px rgba(255, 255, 255, 0.8)',
      '--shadow-outer-white': '0 -.75px rgba(255,255,255,0.8)',
      '--shadow-drop': '0 .75px 0px rgba(0, 0, 0, 0.1)',
      '--shadow-inner-dark': 'inset 0 .75px 0px rgba(0, 0, 0, 0.05)',
      '--shadow-drop-big': '0 1px 2px rgba(0, 0, 0, 0.1)'
    }
  };

  function applyTheme(themeName) {
    const theme = themes[themeName] || themes.dark;
    const root = document.documentElement;
    
    Object.entries(theme).forEach(([property, value]) => {
      root.style.setProperty(property, value);
    });
    
    // Save preference
    // In a real plugin, we'd save this to clientStorage via postMessage
    // For now, we'll just keep it in memory/DOM state
    document.documentElement.setAttribute('data-theme', themeName);
  }

  // ========================================
  // LOADING STATE HELPERS
  // ========================================
  
  function showLoading(message = 'Loading...') {
      const overlay = document.getElementById('loading-overlay');
      const messageEl = document.getElementById('loading-message');
      messageEl.textContent = message;
      overlay.style.display = 'flex';
  }

  function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = 'none';
  }

  // ========================================
  // SCENE MANAGEMENT FUNCTIONS
  // ========================================
  
  function handleVisualizePath(sceneIndex) {
    const data = getPathData(sceneIndex);
    if (!data) {
        alert(scenes.length < 2 ? "Need at least two scenes." : "Cannot visualize path from the last scene.");
        return;
    }

    // Include sceneIndex in pathData for unique naming
    data.sceneIndex = sceneIndex;
    parent.postMessage({ pluginMessage: { type: 'draw-path', pathData: data } }, '*');
  }

  function handleHidePath(sceneIndex) {
    parent.postMessage({ pluginMessage: { type: 'hide-path', sceneIndex: sceneIndex } }, '*');
  }

  function handleResetPath(sceneIndex) {
    if (sceneIndex === scenes.length - 1 || scenes.length < 2) return;
    
    // Clear the custom control point, forcing recalculation to default
    scenes[sceneIndex].customControlPoint = null;
    saveProject();
    
    // Redraw the path with default control point
    handleVisualizePath(sceneIndex);
    renderList();
  }

  function handleRecalculatePath(sceneIndex) {
    if (sceneIndex === scenes.length - 1 || scenes.length < 2) return;
    
    parent.postMessage({ pluginMessage: { type: 'get-control-point', sceneIndex: sceneIndex } }, '*');
  }

  // --- 5. RENDER LIST ---
  
  let draggedItemIndex = null;

  function handleDragStart(e, index) {
      draggedItemIndex = index;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
  }

  function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
  }

  function handleDrop(e, index) {
      e.preventDefault();
      if (draggedItemIndex === null || draggedItemIndex === index) return;

      // Reorder array
      const itemToMove = scenes[draggedItemIndex];
      scenes.splice(draggedItemIndex, 1);
      scenes.splice(index, 0, itemToMove);
      
      // Update current index if needed
      if (currentSceneIndex === draggedItemIndex) {
          currentSceneIndex = index;
      } else if (currentSceneIndex > draggedItemIndex && currentSceneIndex <= index) {
          currentSceneIndex--;
      } else if (currentSceneIndex < draggedItemIndex && currentSceneIndex >= index) {
          currentSceneIndex++;
      }

      draggedItemIndex = null;
      renderList();
      saveProject();
  }

  function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedItemIndex = null;
  }

  // ========================================
  // ICON CONSTANTS (Global Scope)
  // ========================================
  
  const iconEye = `<svg width="10" height="11" viewBox="0 0 10 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.375 8.875C3.375 9.70343 2.70343 10.375 1.875 10.375C1.04657 10.375 0.375 9.70343 0.375 8.875C0.375 8.04657 1.04657 7.375 1.875 7.375C2.70343 7.375 3.375 8.04657 3.375 8.875ZM3.375 8.875H7.625C8.08913 8.875 8.53425 8.69063 8.86244 8.36244C9.19063 8.03425 9.375 7.58913 9.375 7.125C9.375 6.66087 9.19063 6.21575 8.86244 5.88756C8.53425 5.55937 8.08913 5.375 7.625 5.375H2.125C1.66087 5.375 1.21575 5.19063 0.887563 4.86244C0.559375 4.53425 0.375 4.08913 0.375 3.625C0.375 3.16087 0.559375 2.71575 0.887563 2.38756C1.21575 2.05937 1.66087 1.875 2.125 1.875H6.375M6.375 1.875C6.375 2.70343 7.04657 3.375 7.875 3.375C8.70343 3.375 9.375 2.70343 9.375 1.875C9.375 1.04657 8.70343 0.375 7.875 0.375C7.04657 0.375 6.375 1.04657 6.375 1.875Z" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconEyeOff = `<svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.875 8.875C3.875 9.70343 3.20343 10.375 2.375 10.375C1.54657 10.375 0.875 9.70343 0.875 8.875C0.875 8.04657 1.54657 7.375 2.375 7.375C3.20343 7.375 3.875 8.04657 3.875 8.875ZM3.875 8.875H8.125C8.325 8.875 8.575 8.825 8.775 8.775M1.975 1.975C1.59976 2.12887 1.28907 2.40927 1.09591 2.76837C0.902745 3.12747 0.839082 3.54303 0.915773 3.94419C0.992464 4.34534 1.20476 4.70724 1.51645 4.96816C1.82815 5.22908 2.21994 5.37287 2.625 5.375H5.375M0.375 0.375L10.375 10.375M9.875 7.025C9.85107 6.59518 9.66954 6.18926 9.36514 5.88486C9.06074 5.58046 8.65482 5.39893 8.225 5.375M6.875 1.875H4.725M6.875 1.875C6.875 2.70343 7.54657 3.375 8.375 3.375C9.20343 3.375 9.875 2.70343 9.875 1.875C9.875 1.04657 9.20343 0.375 8.375 0.375C7.54657 0.375 6.875 1.04657 6.875 1.875Z" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;

  const iconRefresh = `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.375 4.875C0.375 3.68153 0.849106 2.53693 1.69302 1.69302C2.53693 0.849106 3.68153 0.375 4.875 0.375C6.13302 0.379733 7.34052 0.870612 8.245 1.745L9.375 2.875M9.375 2.875V0.375M9.375 2.875H6.875M9.375 4.875C9.375 6.06847 8.90089 7.21307 8.05698 8.05698C7.21307 8.90089 6.06847 9.375 4.875 9.375C3.61698 9.37027 2.40948 8.87939 1.505 8.005L0.375 6.875M0.375 6.875H2.875M0.375 6.875V9.375" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconPlay = `<svg width="9" height="10" viewBox="0 0 9 10" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.375 1.3753C0.374948 1.19934 0.421323 1.02649 0.509442 0.874191C0.597561 0.721893 0.724305 0.595541 0.876875 0.507894C1.02945 0.420247 1.20244 0.374408 1.37839 0.375006C1.55435 0.375603 1.72703 0.422616 1.879 0.511296L7.8775 4.0103C8.02888 4.09814 8.15456 4.22417 8.24197 4.3758C8.32938 4.52743 8.37547 4.69934 8.37562 4.87437C8.37577 5.04939 8.32998 5.22138 8.24284 5.37316C8.15569 5.52494 8.03023 5.65119 7.879 5.7393L1.879 9.2393C1.72703 9.32798 1.55435 9.37499 1.37839 9.37559C1.20244 9.37618 1.02945 9.33035 0.876875 9.2427C0.724305 9.15505 0.597561 9.0287 0.509442 8.8764C0.421323 8.7241 0.374948 8.55125 0.375 8.3753V1.3753Z" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconTrash = `<svg width="10" height="11" viewBox="0 0 10 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M8.375 2.375V9.375C8.375 9.64022 8.26964 9.89457 8.08211 10.0821C7.89457 10.2696 7.64022 10.375 7.375 10.375H2.375C2.10978 10.375 1.85543 10.2696 1.66789 10.0821C1.48036 9.89457 1.375 9.64022 1.375 9.375V2.375M0.375 2.375H9.375M2.875 2.375V1.375C2.875 1.10978 2.98036 0.85543 3.16789 0.667893C3.35543 0.480357 3.60978 0.375 3.875 0.375H5.875C6.14022 0.375 6.39457 0.480357 6.58211 0.667893C6.76964 0.85543 6.875 1.10978 6.875 1.375V2.375" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconDrag = `<svg width="6" height="11" viewBox="0 0 6 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.958333 5.625C1.2805 5.625 1.54167 5.36383 1.54167 5.04167C1.54167 4.7195 1.2805 4.45833 0.958333 4.45833C0.636167 4.45833 0.375 4.7195 0.375 5.04167C0.375 5.36383 0.636167 5.625 0.958333 5.625Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M0.958333 1.54167C1.2805 1.54167 1.54167 1.2805 1.54167 0.958333C1.54167 0.636167 1.2805 0.375 0.958333 0.375C0.636167 0.375 0.375 0.636167 0.375 0.958333C0.375 1.2805 0.636167 1.54167 0.958333 1.54167Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M0.958333 9.70833C1.2805 9.70833 1.54167 9.44717 1.54167 9.125C1.54167 8.80284 1.2805 8.54167 0.958333 8.54167C0.636167 8.54167 0.375 8.80284 0.375 9.125C0.375 9.44717 0.636167 9.70833 0.958333 9.70833Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4.45833 5.625C4.7805 5.625 5.04167 5.36383 5.04167 5.04167C5.04167 4.7195 4.7805 4.45833 4.45833 4.45833C4.13617 4.45833 3.875 4.7195 3.875 5.04167C3.875 5.36383 4.13617 5.625 4.45833 5.625Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4.45833 1.54167C4.7805 1.54167 5.04167 1.2805 5.04167 0.958333C5.04167 0.636167 4.7805 0.375 4.45833 0.375C4.13617 0.375 3.875 0.636167 3.875 0.958333C3.875 1.2805 4.13617 1.54167 4.45833 1.54167Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4.45833 9.70833C4.7805 9.70833 5.04167 9.44717 5.04167 9.125C5.04167 8.80284 4.7805 8.54167 4.45833 8.54167C4.13617 8.54167 3.875 8.80284 3.875 9.125C3.875 9.44717 4.13617 9.70833 4.45833 9.70833Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;

  // ========================================

function renderList() {
    const list = document.getElementById('scene-list');
    list.innerHTML = '';
    
    const fragment = document.createDocumentFragment(); 
    
    scenes.forEach((scene, index) => {
      
      const li = document.createElement('div');
      
      const isActive = index === currentSceneIndex ? ' scene-item-active' : '';
      li.className = 'scene-item' + isActive;
      
      // Drag & Drop Attributes
      li.setAttribute('draggable', 'true');
      li.ondragstart = (e) => handleDragStart(e, index);
      li.ondragover = (e) => handleDragOver(e);
      li.ondrop = (e) => handleDrop(e, index);
      li.ondragend = (e) => handleDragEnd(e);
      
      // Path settings are on the scene BEFORE the target. For the last scene, 
      // the path is from the last scene back to the first, so we use the LAST scene's settings.
      const pathSettingsIndex = index;
      const isLastScene = index === scenes.length - 1;

      const hasCustomPath = isLastScene || !!scenes[pathSettingsIndex].customControlPoint; 
      const visualizeBtnClass = hasCustomPath ? 'btn-visualize btn-recalculate' : 'btn-visualize';
      const visualizeBtnText = hasCustomPath ? 'Redraw Path' : 'Visualize Path';
      
      const pathControlsVisible = scene.pathControlsVisible || false;
      const eyeIcon = pathControlsVisible ? iconEyeOff : iconEye;
      
      li.innerHTML = `
        <div class="scene-top-row">
            <div class="drag-handle" title="Drag to reorder">${iconDrag}</div>
            <input type="text" class="scene-name-input" data-prop="name" id="name-${index}" value="${scene.name}">
            <div class="actions">
                <div class="path-toggle-wrapper">
                    <button title="${pathControlsVisible ? 'Hide' : 'Show'} path" data-action="toggle-path" data-index="${index}">${eyeIcon}</button>
                    <div class="path-controls-popup" id="path-controls-${index}" style="display: ${pathControlsVisible ? 'flex' : 'none'};">
                        <button class="btn-visualize" data-action="recalculate" data-index="${index}" title="Update path">UPDATE</button>
                        <button class="btn-visualize" data-action="reset-path" data-index="${index}" title="Reset path">REFRESH</button>
                    </div>
                </div>
                <button title="Update scene with current view" data-action="update" data-index="${index}">${iconRefresh}</button>
                <button title="Play this scene" data-action="play" data-index="${index}">${iconPlay}</button>
                <button title="Delete scene" data-index="${index}" data-action="delete">${iconTrash}</button>
            </div>
        </div>
        
        <div class="scene-edit-row">
            <div class="control-group"><label>Dur</label><input type="number" class="duration-input" data-prop="duration" id="dur-${index}" value="${scene.duration}" min="100"></div>
            <div class="control-group"><label>Delay</label><input type="number" class="delay-input" data-prop="delay" id="delay-${index}" value="${scene.delay}" min="0"></div>
            
            <div class="control-group">
                <label>Ease</label>
                <select id="easing-${index}" data-prop="easing">
                    <option value="custom">Custom Bezier</option>
                    <optgroup label="Basic">
                        <option value="linear">Linear</option>
                        <option value="ease">Ease</option>
                        <option value="ease-in">Ease In</option>
                        <option value="ease-out">Ease Out</option>
                        <option value="ease-in-out">Ease In-Out</option>
                    </optgroup>
                    <optgroup label="Dramatic">
                        <option value="snap">Snap (Quart)</option>
                        <option value="smooth">Smooth</option>
                        <option value="ease-in-expo">Expo In</option>
                        <option value="ease-out-expo">Expo Out</option>
                    </optgroup>
                    <optgroup label="Overshoot">
                        <option value="ease-in-back">Back In</option>
                        <option value="ease-out-back">Back Out</option>
                        <option value="ease-in-out-back">Back In-Out</option>
                        <option value="spring">Spring</option>
                    </optgroup>
                    <optgroup label="Circular">
                        <option value="ease-in-circ">Circ In</option>
                        <option value="ease-out-circ">Circ Out</option>
                    </optgroup>
                </select>
            </div>
        </div>
        
        <div class="bezier-row" id="bezier-row-${index}">
            <label>Bezier (x1, y1, x2, y2)</label>
            <input type="text" data-prop="bezier" id="bezier-text-input-${index}" value="${scene.bezier}" placeholder="0.24, 0.61, 0.48, 1.0">
        </div>
      `;
      
      // Use li.querySelector instead of document.getElementById for detached element
      const easingSelect = li.querySelector(`#easing-${index}`);
      if (easingSelect) {
          easingSelect.value = scene.easing;
      }
      
      const bezierRow = li.querySelector(`#bezier-row-${index}`);
      if (bezierRow) {
          bezierRow.style.display = scene.easing === 'custom' ? 'flex' : 'none';
      }
      
      // The last scene doesn't have path controls since there's no transition from it
      // (Path controls are now inline and controlled by toggle)

      // Handle top-row action buttons (update, play, delete, toggle-path)
      li.querySelectorAll('.scene-top-row .actions button').forEach(button => {
          const index = parseInt(button.dataset.index);
          const action = button.dataset.action;
          
          if (action === 'update') {
              button.onclick = () => handleUpdateSceneView(index);
          } else if (action === 'play') {
              button.onclick = () => handlePlayScene(index);
          } else if (action === 'delete') {
              button.onclick = () => handleDeleteScene(index);
          } else if (action === 'toggle-path') {
              button.onclick = () => handleTogglePath(index);
          } else if (action === 'recalculate') {
              button.onclick = () => handleRecalculatePath(index);
          } else if (action === 'reset-path') {
              button.onclick = () => handleResetPath(index);
          }
      });


      li.querySelectorAll('input[type="number"], input[type="text"], select').forEach(input => {
          const index = scenes.indexOf(scene);
          const prop = input.dataset.prop;
          
          input.onchange = (e) => {
              let value = e.target.value;
              
              if (input.type === 'number') {
                  value = parseInt(e.target.value) || 0;
              } else if (prop === 'name') {
                  value = value.trim() || `Scene ${index + 1}`;
                  e.target.value = value;
              }

              handleUpdateScene(index, prop, value);

              if (prop === 'easing') {
                  // Ensure the correct bezierRow is targeted
                  const currentBezierRow = li.querySelector(`#bezier-row-${index}`);
                  if (currentBezierRow) {
                      currentBezierRow.style.display = e.target.value === 'custom' ? 'flex' : 'none';
                  }
              }
          };
      });
      
      // Append the item to the fragment
      fragment.appendChild(li); 
    });
    
    // Append the fragment to the live DOM in one go
    list.appendChild(fragment);
    
    // Show/hide empty state based on scene count
    const emptyState = document.getElementById('empty-state');
    if (scenes.length === 0) {
        list.style.display = 'none';
        emptyState.style.display = 'flex';
    } else {
        list.style.display = 'flex';
        emptyState.style.display = 'none';
    }
  }

  // Toggle path visualization and controls
  function handleTogglePath(index) {
      const scene = scenes[index];
      const isVisible = scene.pathControlsVisible || false;
      
      if (isVisible) {
          // Hide path and controls
          handleHidePath(index);
          scene.pathControlsVisible = false;
      } else {
          // Check if we can visualize a path from this scene
          const pathData = getPathData(index);
          if (!pathData) {
              alert(scenes.length < 2 ? "Need at least two scenes to visualize a path." : "Cannot visualize path from the last scene.");
              return;
          }
          
          // Show path and controls
          handleVisualizePath(index);
          scene.pathControlsVisible = true;
      }
      saveProject();
      renderList(); // Re-render to update the buttons and icon
  }


  // --- 6. GLOBAL BUTTONS & ANIMATION ENGINE (FIXED LOGIC) ---
  
  document.getElementById('btn-capture').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'capture-scene' } }, '*');
  };
  
  function handlePlayNavigation(direction) {
    if (is_playing) return; 

    if (scenes.length < 2) {
        alert("Need at least two scenes for playback.");
        return;
    }

    // 1. Determine the target index (the scene we animate TO)
    let nextIndex = currentSceneIndex + direction;

    if (nextIndex < 0) {
        nextIndex = scenes.length - 1; 
    } else if (nextIndex >= scenes.length) {
        nextIndex = 0;
    }
    
    // 2. Determine the path settings index (the scene we animate FROM)
    let pathSettingsIndex;
    // Check for wrap-around case first
    if ((currentSceneIndex === 0 && nextIndex === scenes.length - 1) || 
        (currentSceneIndex === scenes.length - 1 && nextIndex === 0)) {
        pathSettingsIndex = scenes.length - 1;
    } else {
        pathSettingsIndex = Math.min(currentSceneIndex, nextIndex);
    } 
    
    // 3. Set the payload and send message to capture current view (start point)
    targetViewPayload = {
        targetScene: scenes[nextIndex],
        pathSettingsIndex: pathSettingsIndex
    };
    
    parent.postMessage({ pluginMessage: { type: 'capture-scene', ...targetViewPayload } }, '*');
    
    // 4. Update the tracker for the next click AND refresh the list
    currentSceneIndex = nextIndex;
    renderList(); // Refresh the list to apply the active class
}
  
  document.getElementById('btn-play-previous').onclick = () => {
    handlePlayNavigation(-1); 
  };
  
  document.getElementById('btn-play-next').onclick = () => {
    handlePlayNavigation(1);
  };


// Helper function to reset the button and state
function resetPlayButton() {
    is_playing = false;
    const playButton = document.getElementById('btn-play-all');
    playButton.textContent = 'Play';
    playButton.classList.remove('btn-stop');
    
    // Cancel any pending animation frame
    if (animation_frame_id) {
        cancelAnimationFrame(animation_frame_id);
    }
}

// Function to handle the Stop action
function stopPlayback() {
    resetPlayButton();
}

async function startPlayback() {
    if (scenes.length < 2) {
        alert("Need at least two scenes for playback.");
        return;
    }
    
    // 1. Set Playing State and UI
    is_playing = true;
    const playButton = document.getElementById('btn-play-all');
    playButton.textContent = 'Stop';
    playButton.classList.add('btn-stop');
    
    for (let i = 0; i < scenes.length; i++) {
        // Stop check inside the loop, handles early exit between scene transitions
        if (!is_playing) break; 
        
        const target = scenes[i];
        // The path settings are taken from the scene we just animated FROM. 
        // When going to scene i, the path settings used are from the previous scene (i-1).
        // For the first scene (i=0), the path settings should be from the last scene in the list (loop).
        const pathSettingsIndex = (i === 0) ? scenes.length - 1 : i - 1; 
        const pathScene = scenes[pathSettingsIndex];
        
        // STEP 1: Capture the starting point
        const currentView = await new Promise(resolve => {
            // Temporarily replace the global handler to capture the immediate response
            const tempHandler = (event) => {
                const msg = event.data.pluginMessage;
                if (msg && msg.type === 'scene-captured' && !msg.targetScene) {
                    window.onmessage = messageHandler; // Restore the global handler
                    resolve(msg.view);
                }
            };
            window.onmessage = tempHandler; 
            parent.postMessage({ pluginMessage: { type: 'capture-scene' } }, '*'); 
        });
        
        if (currentView) {
            const customControlPoint = pathScene ? pathScene.customControlPoint : null;
            const duration = pathScene.duration;
            const easing = pathScene.easing;
            const delay = pathScene.delay;
            const bezier = pathScene.bezier;

            // Wait for animation + delay to complete
            await animate(currentView, target.view, duration, easing, delay, bezier, customControlPoint, true);
        }
        
        // Stop check after animation/delay promise resolves
        if (!is_playing) break; 
        
        currentSceneIndex = i; 
        renderList(); // Update active state during playback
    }
    
    // 3. Final Reset (only if the loop finished or was broken)
    if (is_playing) {
        currentSceneIndex = 0; 
        renderList(); // Final list render to highlight Scene 1
    }

    resetPlayButton(); // Reset button appearance and state
}

// The new combined button handler
document.getElementById('btn-play-all').onclick = () => {
    if (is_playing) {
        stopPlayback();
    } else {
        startPlayback();
    }
};

document.getElementById('btn-toggle-theme').onclick = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    applyTheme(newTheme);
};

// Initialize theme
applyTheme('dark');
  
  const messageHandler = (event) => {
    const msg = event.data.pluginMessage;
    
    if (msg.type === 'scene-captured') {
      if (msg.targetScene) {
        // This is a Play/Navigation event, msg contains the start view and the target details
        const startView = msg.view;
        const targetView = msg.targetScene;
        const pathSettingsIndex = msg.pathSettingsIndex;
        
        const pathScene = scenes[pathSettingsIndex];
        
        const customControlPoint = pathScene ? pathScene.customControlPoint : null;
        const duration = pathScene.duration;
        const easing = pathScene.easing;
        const delay = pathScene.delay;
        const bezier = pathScene.bezier;
        
        let activeControlPoint = customControlPoint;

        // Ensure default control point respects segment direction
        if (!activeControlPoint && isArcEnabled && pathScene) {
             const segmentStartIndex = pathSettingsIndex;
             const segmentEndIndex = (pathSettingsIndex + 1) % scenes.length;
             
             // We need to find the scenes corresponding to these indices to get their views
             const segStart = scenes[segmentStartIndex].view;
             const segEnd = scenes[segmentEndIndex].view;
             
             const defaultControl = calculateArcControlPoint(segStart, segEnd);
             activeControlPoint = { x: defaultControl.xc, y: defaultControl.yc };
        }
        
        animate(startView, targetView.view, duration, easing, delay, bezier, activeControlPoint);
        targetViewPayload = null;
        
      } else if (msg.updateIndex !== undefined) {
          // This is an Update Scene event
          const index = msg.updateIndex;
          if (scenes[index]) {
              scenes[index].view = msg.view;
              saveProject();
              // Optional: Visual feedback?
              // renderList(); // Not strictly necessary if we just updated data, but good to ensure consistency
              // Maybe flash the item?
              const item = document.getElementById(`name-${index}`).closest('.scene-item');
              if (item) {
                  item.style.backgroundColor = '#30b050'; // Flash green
                  setTimeout(() => {
                      item.style.backgroundColor = ''; // Revert to CSS default (or remove inline style)
                  }, 300);
              }
          }
      } else {
        // This is a Capture Scene event (no targetScene in the message)
        const newScene = {
          id: Date.now(),
          name: `Scene ${scenes.length + 1}`,
          view: msg.view,
          duration: 2000, 
          easing: 'smooth',  
          delay: 500,
          bezier: "0.24, 0.61, 0.48, 1.0",
          customControlPoint: null 
        };
        scenes.push(newScene);
        renderList();
        currentSceneIndex = scenes.length - 1; 
        saveProject(); 
        setPluginView('scenes', true); // Ensure expanded view after adding the first scene
      }
    } else if (msg.type === 'load-data') {
        initializeData(msg.data, msg.projectName);
    } else if (msg.type === 'control-point-updated') {
        if (msg.point) {
            const index = msg.sceneIndex;
            scenes[index].customControlPoint = msg.point;
            
            handleVisualizePath(index);
            
            saveProject();
            renderList(); 
        } else {
            alert("Control Point marker not found. Please click 'Visualize Path' first to place the marker on the canvas.");
        }
    }
  };
  window.onmessage = messageHandler;

function animate(start, end, duration, easing, delay, bezierString, customControlPoint, checkStop = false) {
    return new Promise(resolve => {
      const startTime = performance.now();
      
      if (duration === 0) duration = 1; 
      
      const bezierPoints = parseBezierString(bezierString);
      
      let control = null;
      if (isArcEnabled) {
          if (customControlPoint) {
              control = { xc: customControlPoint.x, yc: customControlPoint.y };
          } else {
              control = calculateArcControlPoint(start, end); 
          }
      }

      // Track last sent values to avoid redundant updates
      let lastSentX = null;
      let lastSentY = null;
      let lastSentZoom = null;
      
      // Smoothed values for dampened movement
      let smoothX = start.x;
      let smoothY = start.y;
      let smoothZoom = start.zoom;
      
      // Smoothing factor (0.0-1.0): lower = smoother/floatier
      // 0.15 gives very smooth, cinematic camera movement
      const SMOOTHING = 0.15;
      
      // Lower threshold for more responsive but smooth updates
      const POSITION_THRESHOLD = 0.25;
      const ZOOM_THRESHOLD = 0.0002;

      function loop() {
        if (checkStop && !is_playing && animation_frame_id) {
            cancelAnimationFrame(animation_frame_id);
            return resolve(true);
        }

        const now = performance.now();
        const rawProgress = Math.min((now - startTime) / duration, 1);
        
        const easedProgress = getEasing(rawProgress, easing, bezierPoints); 

        // Clamp eased progress to prevent overshoot artifacts
        const clampedProgress = Math.max(0, Math.min(1, easedProgress));

        const currentZoom = start.zoom + (end.zoom - start.zoom) * clampedProgress;
        
        let currentX, currentY;

        if (isArcEnabled && control) { 
            const t = clampedProgress;
            const oneMinusT = 1 - t;
            
            // Quadratic Bezier Interpolation
            currentX = oneMinusT * oneMinusT * start.x + 2 * oneMinusT * t * control.xc + t * t * end.x;
            currentY = oneMinusT * oneMinusT * start.y + 2 * oneMinusT * t * control.yc + t * t * end.y;

        } else {
            // Linear interpolation
            currentX = start.x + (end.x - start.x) * clampedProgress;
            currentY = start.y + (end.y - start.y) * clampedProgress;
        }

        // Apply exponential smoothing to dampen sudden changes
        smoothX += (currentX - smoothX) * SMOOTHING;
        smoothY += (currentY - smoothY) * SMOOTHING;
        smoothZoom += (currentZoom - smoothZoom) * SMOOTHING;

        // Only send update if smoothed values changed significantly
        const xChanged = lastSentX === null || Math.abs(smoothX - lastSentX) > POSITION_THRESHOLD;
        const yChanged = lastSentY === null || Math.abs(smoothY - lastSentY) > POSITION_THRESHOLD;
        const zoomChanged = lastSentZoom === null || Math.abs(smoothZoom - lastSentZoom) > ZOOM_THRESHOLD;
        
        if (xChanged || yChanged || zoomChanged) {
            parent.postMessage({ pluginMessage: { type: 'update-viewport', x: smoothX, y: smoothY, zoom: smoothZoom } }, '*');
            lastSentX = smoothX;
            lastSentY = smoothY;
            lastSentZoom = smoothZoom;
        }

        if (rawProgress < 1) {
          animation_frame_id = requestAnimationFrame(loop);
        } else {
          // Ensure final position is exactly the end point
          parent.postMessage({ pluginMessage: { type: 'update-viewport', x: end.x, y: end.y, zoom: end.zoom } }, '*');
          // Animation finished, use setTimeout to handle the delay
          setTimeout(resolve, delay);
        }
      }
      
      // Start the loop
      animation_frame_id = requestAnimationFrame(loop); 
    });
}
</script>
</html>