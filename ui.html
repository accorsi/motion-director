<!DOCTYPE html>
<html>
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400&display=swap" rel="stylesheet">
<style>
  /* --- 1. COLOR PALETTE & FONT --- */
  :root {
    --color-bg-darker: rgb(12, 14, 13, 0.10);
    --color-bg-dark: hsl(160, 6%, 9%, 0.10);
    --color-bg-medium: hsl(160, 4%, 14%, 0.1);
    --color-bg-regular: hsl(160, 4%, 18%, 0.4);
    --color-bg-light: hsl(160, 4%, 22%, 0.6); 
    --color-text-main: hsl(160, 6%, 91%, 0.80); 
    --color-text-faded: hsla(168, 5%, 81%, 0.5); 
    --color-accent-blue: #007AFF; 
    --color-accent-orange: hsl(42, 100%, 52%);
    --color-accent-orange-hover: hsl(42, 100%, 62%); 
    --color-accent-orange-light: hsla(42, 100%, 92%, 0.9);
    --color-accent-red: #FF3B30; 
    --color-accent-green: #12d067;
    --color-accent-green-hover: #0aef71;
    --color-accent-green-faded: #0aef7190;
    --color-border: #00000000;

    --font-main: 'Geist Mono', monospace; 
    --font-size-base: 10px; 
    --font-size-small: 9px;
    --font-size-medium: 12px;
    --font-size-large: 14px;
    --font-size-tiny: 8px;

    --shadow-inner-light: inset 0 .75px 0px rgba(255, 255, 255, 0.1);
    --shadow-inner-lighter: inset 0 .75px 0px rgba(255, 255, 255, 0.35);
    --shadow-outer-white: 0 -.75px rgba(255,255,255,.6);
    --shadow-drop: 0 .75px 0px rgba(0, 0, 0, 0.5); 
    --shadow-inner-dark: inset 0 .75px 0px rgba(0, 0, 0, 0.5);
    --shadow-drop-big: 0 1px 0px rgba(0, 0, 0, 0.5), 0 2px 4px rgba(0, 0, 0, 0.25), 0 4px 8px rgba(0, 0, 0, 0.125), 0 8px 16px rgba(0, 0, 0, 0.0625);
    --shadow-inner-active: inset 0 0 0px .75px var(--color-accent-green-hover);

    --radius-small: 2px;
    --radius-medium: 4px;
    --radius-large: 8px;

    --spacing-xxs: 2px;
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-base: 16px;
    --spacing-md: 24px;
    --spacing-lg: 32px;
    --spacing-xl: 48px;
    --spacing-xxl: 64px;

  }

  /* --- 2. CORE BAR STYLES --- */
  html, body { 
      font-family: var(--font-main); 
      font-size: var(--font-size-base);
      padding: 0; margin: 0; 
      background-color: #0a0b0a; /* Very dark base */
      background-image: url('noise-texture.png');
      background-repeat: repeat;
      background-blend-mode: screen; /* Screen blend for grainy look */
      color: var(--color-text-main); 
      overflow: hidden; 
      transition: width 0.5s ease-out, height 0.5s ease-out, position 0.5s ease-out; 
      font-weight: 400;
      height: 100%;
      overflow: visible;
  }

  /* --- 3. HEADER/CONTROL LAYOUT --- */
  header { 
      display: flex; justify-content: space-between; align-items: left; 
      padding: 4px; 
      height: 32px; box-sizing: content-box; 
      background: transparent; /* Let noise texture show through */
      z-index: 10; 
      position: relative;
      gap: 4px;
      transition: width 0.5s ease-out, height 0.5s ease-out; 
  }

  .controls-left { 
      display: flex; 
      flex-direction: row; 
      gap: 4px; 
      width: 100%;
      padding-top: 0px;
      align-items: center;
      transition: position 0.25s ease-out, width 0.25s ease-out; 
  }
  
  
  /* Shared Buttons */
  .btn-action { 
      border: none; 
      border-radius: var(--radius-medium); 
      font-weight: 400; 
      cursor: pointer; 
      user-select: none;
      transition: 0.15s; 
      height: 32px; 
      line-height: 1; 
      box-sizing: border-box;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-family: var(--font-main); 
      white-space: nowrap; 
      flex-shrink: 0; 
      text-transform: uppercase;
      letter-spacing: 0.05em;
      /* Inset shadows for depth */
      box-shadow: 
          inset 0 1px 0 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 0 rgba(0,0,0,0.3),
          0 1px 2px rgba(0,0,0,0.3);
      font-size: var(--font-size-small); 
      /* Noise texture */
      background-image: url('noise-texture.png');
      background-blend-mode: overlay;
  }
  .btn-action:focus-visible {
      outline: .25px solid var(--color-accent-green);
      box-shadow: none;
  }
  .btn-action:focus:not(:focus-visible) {
      outline: none;
      box-shadow: none;
  }
  
  /* 3.1. CAPTURE Button - Orange/Yellow text */
  #btn-capture { 
      background-color: var(--color-bg-medium);
      color: var(--color-accent-orange); 
      padding: 0 10px; 
      transition: 0.3s cubic-bezier(0.24, 0.61, 0.48, 1);
  }
  #btn-capture:hover { 
      background: var(--color-accent-orange);
      color: #0a0b0a;
      text-shadow: 0 .5px 0 rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 10px -3px var(--color-accent-orange-hover);
  }
  #btn-capture:focus-visible {
      outline: .25px solid var(--color-accent-orange);
      box-shadow: none;
  }
  /* 3.2. NAVIGATION Arrows - Dark Buttons */
  .nav-arrows-group { 
      display: flex; 
      gap: 1px;
  }
  .nav-arrows-group button {
      background: var(--color-bg-medium); 
      color: var(--color-text-main);
      padding: 0;
      width: 30px;
  }
  #btn-play-previous {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
  }
  #btn-play-next {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
  }
  .nav-arrows-group button:hover { 
      background-color: rgba(45, 47, 45, 0.3);
  }
  
  /* 3.3. PLAY Button - Green text with white inner glow */
  #btn-play-all { 
      background-color: var(--color-bg-medium); 
      color: var(--color-accent-green); 
      padding: 0 10px;
      font-size: var(--font-size-small); 
      transition: 0.3s cubic-bezier(0.24, 0.61, 0.48, 1);
      /* White inner glow on text */
      text-shadow: 0 0 4px rgba(255,255,255,0.3);
  }
  #btn-play-all:hover { 
      background: var(--color-accent-green);
      color: #0a0b0a;
      text-shadow: 0 .5px 0 rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 10px -3px var(--color-accent-green-hover);
  }
  
  /* STOP BUTTON - Red when playing */
  .btn-stop {
      background-color: var(--color-accent-red) !important;
      color: var(--color-text-main) !important;
  }
  .btn-stop:hover {
      background-color: #c9342c !important; 
  }

  /* 3.4. HIDE PATHS Button */
  #btn-hide-paths {
      background-color: var(--color-bg-medium); 
      color: var(--color-text-main); 
      padding: 0 10px;
  }
  #btn-hide-paths:hover { 
      background-color: rgba(45, 47, 45, 0.3); 
  }

  
  /* 3.5. UTILITY Buttons (Toggle/Settings) */
  .utility-buttons-group {
      display: flex;
      gap: 4px;
  }

  .utility-buttons-group button {
      background: var(--color-bg-medium); 
      color: var(--color-text-main); /* Ensure white/light text color */
      width: 32px; height: 32px; 
      padding: 0;
      font-size: 16px;
      border-radius: var(--radius-large); /* Ensure border radius */
  }
  .utility-buttons-group button:hover { background-color: rgba(45, 47, 45, 0.3); }
  
  /* Specific overrides to ensure they stay dark */
  #btn-toggle-mode, #btn-settings {
      background-color: var(--color-bg-medium);
      color: var(--color-text-main);
      width: 32px;
      height: 32px;
      &:hover { background-color: rgba(45, 47, 45, 0.3); }
  }

  .mode-vertical #btn-toggle-mode {
      width: 100%;
  }
  
  #btn-toggle-mode svg, #btn-settings svg {
      stroke: currentColor; /* Ensure SVGs use the text color */
  }

  #btn-clear-scenes {
      background: var(--color-accent-red); 
      color: var(--color-text-main); 
      padding: 0 12px;
      text-shadow: var(--shadow-outer-white);
      box-shadow: var(--shadow-inner-lighter);
  }
  #btn-clear-scenes:hover { background: var(--color-accent-red-hover); }
  
  /* --- 4. MODE-SPECIFIC STYLES --- */
  
  /* VERTICAL (Mini/Sidebar) Mode */
  .mode-vertical header { 
      flex-direction: column; 
      justify-content: flex-start;
      gap: 2px;
      height: auto; 
      padding: 4px 4px 4px 4px; /* includes 4px bottom padding */
  }
  .mode-vertical .controls-left { 
      display: flex; 
      flex-direction: column; 
      gap: 2px; 
      width: 100%; 
      align-items: center;
      transition: width 0.3s ease-in-out, height 0.3s ease-in-out; 
  }
  
  /* Compact Button Styling for 72px width */
  .mode-vertical .btn-action { 
      width: 100%; 
      font-size: var(--font-size-small);
      padding: 0 4px;
      height: 32px; 
      border-radius: 8px;
      order: 2;
  }
  
  /* Navigation Arrows in Vertical Mode */
  .mode-vertical .nav-arrows-group { 
      flex-direction: row; 
      justify-content: center; 
      width: 100%; 
      gap: 2px; 
      margin: 0;
      order: 1;
  }
  .mode-vertical .nav-arrows-group button { 
      width: 50%; 
      height: 32px;
      border-radius: var(--radius-medium) !important;
      margin: 0;
  }
  
  .mode-vertical #btn-capture { order: 1; } 
  .mode-vertical #btn-play-all { margin-right: 0; order: 0;} 
  .mode-vertical #btn-hide-paths { display: block; padding: 0 2px; width: 100%; } 
  
  /* Utility Group in Vertical Mode */
  .mode-vertical .utility-buttons-group { 
      order: 1; 
      display: flex; 
      justify-content: center; 
      width: 100%;
  }
  .mode-vertical .utility-buttons-group button { 
      width: 100%; 
      height: 32px;
      border-radius: var(--radius-large); 
      font-size: 8px;
  }

  /* --- MINI MODE (40px -> 34px) --- */
  body {
    padding: 0;
    &.mode-mini{ padding:3px 2px 2px 2px; };
    overflow: visible;
  }

  .mode-mini header {
      flex-direction: column; 
      justify-content: flex-start;
      gap: 2px;
      height: 32px; 
      padding: 0px; /* Reduced from 4px to fit 34px width */
      width: 100%;
      box-sizing: border-box;
  }
  .mode-mini .controls-left {
      display: flex; 
      flex-direction: column; 
      gap: 2px; 
      width: 100%; 
      align-items: center;
  }
  /* Buttons in Mini Mode */
  .mode-mini .btn-action {
      width: 32px; /* Fixed width for icon buttons */
      height: 32px;
      padding: 0;
      justify-content: center;
      border-radius: var(--radius-medium);
      order: 2;
  }

  /* Hide Text in Mini Mode ONLY by default */
  .mode-mini .btn-text {
      display: none !important;
  }
  
  /* Hide Icons in Vertical Mode (Text only requested) */
  .mode-vertical .btn-icon {
      display: none !important;
  }
  
  /* Show Icons in Mini Mode */
  .mode-mini .btn-icon {
      display: flex;
      align-items: center;
      justify-content: center;
  }
  
  /* Default: Icons Hidden in Horizontal */
  .btn-icon { display: none; }
  
  /* Ensure SVGs use currentColor */
  .btn-icon svg path {
      stroke: currentColor !important;
  }

  /* Specific Mini Mode Overrides */
  .mode-mini .nav-arrows-group {
      flex-direction: column;
      width: 32px;
      gap: 2px;
      order: 1;
  }
  .mode-mini .nav-arrows-group button {
      width: 100%;
      height: 32px; /* Standardize height to 32px */
      border-radius: var(--radius-small);
  }
  .mode-mini #btn-capture { order: 1; }
  .mode-mini #btn-play-all { order: 0; }
  .mode-mini #btn-hide-paths { display: flex; width: 32px; }
  
  .mode-mini .utility-buttons-group {
      order: 1;
      display: flex;
      flex-direction: column; 
      width: 100%;
      align-items: center;
      gap: 2px;
  }
  .mode-mini .utility-buttons-group button {
      width: 32px;
      height: 32px;
  }

  /* Vertical 72px Mode - Ensure Text Visible, Icons Hidden */
  .mode-vertical .btn-action {
      justify-content: center; 
      width: 100%;
      padding: 0 4px; /* Restore padding for text */
  }
  .mode-vertical .btn-text {
      display: inline-block !important; /* Force text display */
  }
  
  /* Mini Mode - Icons Only */
  .mode-mini .btn-action {
     padding: 0; /* No padding for icon-only */
  }
  
  /* --- 5. EXPANDED/SETTINGS PANEL --- */
  #expanded-panel { 
      overflow-y: hidden; 
      height: calc(100% - 80px);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
  }

  /* SCENE LIST View */
  #scene-list-view {
      display: flex; 
      flex-direction: column;
      height: 100%;
      flex: 1;
      overflow: hidden;
  }

  #scene-list-view .setting-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      overflow: hidden;
      padding: 0 !important; /* Override inline style */
  }

  /* CONFIG View */
  #config-view {
      display: none;
      flex-direction: column;
      gap: 16px;
  }

  h3 { 
      font-size: var(--font-size-base); 
      margin: 0 0 10px 0; 
      color: var(--color-text-faded); 
      font-weight: 400; 
      letter-spacing: 0.05em; 
      text-transform: uppercase;
  }
  .setting-group { margin-bottom: 10px; padding: 12px; 
      border-radius: var(--radius-large); 
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); 
  }
  
  /* --- Scene List Styling --- */
  #scene-list { 
      list-style: none;
      overflow-y: auto; 
      overflow-x: hidden;
      display: flex;
      flex-flow: column;
      gap: 4px;
      flex: 1;
      padding: 0 4px 4px 4px;
  }
  .scene-item { 
      background-color: rgba(30, 32, 30, 0.6); /* Semi-transparent for texture */
      padding: 8px 10px; 
      border-radius: var(--radius-large); 
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: 0.2s;
      opacity: 0.5; /* Inactive cards at 60% */
      /* Inset shadows for depth */
      box-shadow: 
          inset 0 1px 0 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 0 rgba(0,0,0,0.4),
          0 1px 3px rgba(0,0,0,0.3);
  }
  .scene-item:hover {
      opacity: 0.9;
      background-color: rgba(45, 47, 45, 0.3);
  }

  .scene-item-active {
      background-color: rgba(20, 22, 20, 0.9); /* Darker, more opaque */
      opacity: 1; /* Full opacity when active */
      box-shadow: 
          inset 0 0 0 .5    px var(--color-accent-green-faded),
          inset 0 1px 0 0 rgba(255,255,255,0.08),
          inset 0 -1px 0 0 rgba(0,0,0,0.4),
          0 1px 3px rgba(0,0,0,0.3);
          &:hover {
              opacity: 1;
          }
  }

  .scene-top-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 4px; 
  }
  
  /* Left group: drag handle + name */
  .scene-name-group {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 0 1 auto;
      min-width: 0;
      overflow: hidden;
  }

  /* Scene Name Input */
  .scene-name-input { 
      background: none; 
      border: none; 
      color: var(--color-text-main); 
      font-weight: 400; 
      font-size: var(--font-size-base); 
      padding: 2px 0;
      min-width: 50px;
      max-width: 120px;
      flex-shrink: 1;
  }
  .scene-name-input:focus {
      outline: none;
      background: var(--color-bg-darker); 
      padding: 2px 5px;
  }
  
  /* Scene Action Buttons */
  .scene-top-row .actions button { 
      background: none; border: none; color: var(--color-text-faded); 
      font-size: var(--font-size-tiny); 
      cursor: pointer; padding: 2px 4px; transition: color 0.2s; 
      border-radius: var(--radius-small);
  }
  .scene-top-row .actions button:hover { color: var(--color-text-main); }
  .scene-top-row .actions button:focus {
      outline: none;
      box-shadow: 0 0 0 1px var(--color-accent-green);
      color: var(--color-text-main);
  }

  /* Path Toggle Wrapper with Popup */
  .path-toggle-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
  }
  
  .path-controls-popup {
    position: absolute;
    right: 24px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
    margin-left: 0;
    z-index: 10;
    animation: popupIn 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    transform-origin: right center;
  }
  @keyframes popupIn {
      from { opacity: 0; transform: translateY(-50%) scale(0.9); }
      to { opacity: 1; transform: translateY(-50%) scale(1); }
  }
  
  .path-controls-popup .btn-visualize {
      font-size: var(--font-size-tiny);
      padding: 2px 4px;
      margin: 0;
      text-transform: uppercase;
      white-space: nowrap;
  }


  /* Control Inputs (Duration, Delay, Easing) */
  .scene-edit-row { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; justify-content: space-between;}
  .bezier-row { margin-top: var(--spacing-sm); display: flex; align-items: center; justify-content: space-between;}
  
  label { 
      font-size: var(--font-size-tiny); 
      color: var(--color-text-faded); 
      text-transform: uppercase; 
      margin-right: 6px; 
      letter-spacing: -0.01em; 
      font-weight: 400;
      text-shadow: var(--shadow-inner-dark);
  }
  .control-group { display: flex; align-items: center; }
  
  /* Input/Select Consistency */
  .control-group input[type="number"],
  .control-group select {
      background: var(--color-bg-medium); 
      color: var(--color-text-main); 
      border: 0px solid transparent; 
      padding: 4px;
      height: 24px;
      width: 40px;
      box-sizing: border-box;
      border-radius: var(--radius-small); 
      font-size: var(--font-size-tiny); 
      text-align: right; 
      appearance: none; 
      -moz-appearance: textfield;
      font-family: var(--font-main);
      font-weight: 400;
  }
  .control-group select {
      width: 88px;
      text-align: left;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='8' height='4' viewBox='0 0 8 4' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0.5 0.5L4 3.5L7.5 0.5' stroke='%23888888' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 16px;
      padding-left: 8px;
      height: 24px;
  }
  
  /* Green focus for ALL inputs/selects */
  .control-group input[type="number"]:focus,
  .control-group select:focus,
  input[type="text"]:focus,
  input[type="number"]:focus,
  select:focus {
      outline: var(--color-accent-green) solid .25px;
      box-shadow: 
          0 0 0 .5px var(--color-accent-green),
          inset 0 1px 0px rgba(0,0,0,1);
  }
  
  /* Hide Number Spinners */
  input[type=number]::-webkit-inner-spin-button, 
  input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
  }

  /* Drag Handle */
  .drag-handle {
      cursor: grab;
      color: var(--color-text-faded);
      display: flex;
      align-items: center;
      margin-right: 8px;
  }
  .drag-handle:active {
      cursor: grabbing;
  }
  .scene-item.dragging {
      opacity: 0.5;
      border: .75px dashed var(--color-text-faded);
  }
  
  .bezier-row input[type="text"] {
      flex-grow: 1; padding: 6px; 
      background: var(--color-bg-dark); color: var(--color-text-main); border: 1px solid var(--color-border); 
      border-radius: var(--radius-medium); font-size: var(--font-size-small); font-family: var(--font-main); text-align: left;
      height: 24px;
      box-sizing: border-box;
      font-weight: 400;
  }
  
  /* Visualize Path Button Row */
  .scene-actions-bottom { 
      display: flex; justify-content: space-between; 
      margin-top: 10px; 
      border-top: 1px solid var(--color-border); 
      padding-top: 8px; 
  }
  .btn-visualize { 
      background: var(--color-bg-medium);
      color: var(--color-text-faded);
      padding: 4px 6px;
      font-size: var(--font-size-tiny);
      font-weight: 400;
      cursor: pointer;
      border-radius: var(--radius-small);
      transition: background 0.3s;
      font-family: var(--font-main);
  }
  .btn-visualize:hover {
      background: #333;
  }
  
  .btn-recalculate {
      border: 1px solid var(--color-border);
      background: var(--color-bg-medium);
      color: var(--color-text-faded);
  }
  .btn-recalculate:hover {
      background: #333;
  }

  /* Project Manager styles */
  .project-manager input,
  .project-buttons button {
      font-size: var(--font-size-small); 
      font-weight: 400;
  }
  .project-manager input {
      padding: 6px;
      height: 30px;
      box-sizing: border-box;
      background: var(--color-bg-light);
      border: 1px solid var(--color-border);
      color: var(--color-text-main);
      border-radius: var(--radius-medium);
      width: 100%;
      margin-bottom: 8px;
      font-family: var(--font-main);
  }
  .project-buttons {
      display: flex;
      gap: 8px;
      justify-content: space-between;
  }
  .project-buttons button {
      background: var(--color-bg-dark);
      color: var(--color-text-main);
      border: 1px solid var(--color-border);
      padding: 6px 12px;
      border-radius: var(--radius-large);
      cursor: pointer;
      transition: background 0.2s;
      flex-grow: 1;
      font-family: var(--font-main);
  }
  .project-buttons button:hover {
      background: #282828;
  }

  /* General Settings */
  .size-controls {
      display: flex;
      gap: 16px;
      margin-top: 10px;
  }
  .control-group input[type="number"] {
      text-align: left;
      padding: 4px 8px;
  }
  #plugin-mode-select {
      width: 100%;
      text-align: left;
      padding: 4px 8px;
      height: 30px;
  }

  #arc-enabled-checkbox + label {
      font-size: var(--font-size-base); 
      color: var(--color-text-main); 
      text-transform: none;
      margin: 0;
  }

  /* Hidden elements */
  .hidden-icons {
      display: none;
  }

  #expanded-panel.collapsed {
      display: none;
  }

  /* Scene list container specific overrides */
  #scene-list-view .setting-group {
      margin-bottom: 0;
      padding: 12px 12px 2px 12px;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
  }

  /* Empty State */
  .empty-state {
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      user-select: none;
      
      /* Absolute positioning to center over list */
      position: absolute;
      inset: 0;
      z-index: 10;
  }

  .empty-state-icon {
      margin-bottom: var(--spacing-base);
      opacity: 0.6;
  }

  .empty-state-title {
      font-size: var(--font-size-medium);
      font-weight: 400;
      color: var(--color-text-main);
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-shadow: 0 .5px 0 rgba(0, 0, 0, 0.8);
  }

  .empty-state-message {
      font-size: var(--font-size-base);
      color: var(--color-text-faded);
      margin-bottom: var(--spacing-base);
      max-width: 270px;
      letter-spacing: 0.05em;
      font-weight: 400;
      text-shadow: 0 .5px 0 rgba(0, 0, 0, 0.9);
      line-height: 1.5;

  }

  .empty-state-cta {
      background-color: var(--color-bg-medium);
      color: var(--color-accent-orange); 
      padding: 12px 16px; 
      border: none;
      border-radius: var(--radius-medium);
      font-family: var(--font-main);
      font-size: var(--font-size-small);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: 0.3s cubic-bezier(0.24, 0.61, 0.48, 1);
      text-shadow: 0 -.5px 0 rgba(0, 0, 0, 0.9);
      box-shadow: var(--shadow-inner-light), var(--shadow-drop);
      overflow: visible;
      
  }

  .empty-state-cta:hover {
      background: var(--color-accent-orange);
      color: #0a0b0a;
      text-shadow: 0 .5px 0 rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 10px -3px var(--color-accent-orange-hover);
  }

  /* Loading Overlay */
  .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(2px);
  }

  .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-bg-medium);
      border-top: 3px solid var(--color-accent-green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--spacing-base);
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .loading-message {
      color: var(--color-text-main);
      font-size: var(--font-size-small);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }

  /* Config view specific styles */
  #config-view .control-group.plugin-mode {
      margin-bottom: 10px;
  }

  #config-view .control-group.plugin-mode label {
      margin-right: 8px;
  }

  #config-view .checkbox-group {
      margin-top: 10px;
  }

  /* Utility Classes */
  .d-none {
      display: none !important;
  }

</style>
</head>
<body class="mode-horizontal">

<header>
    <div class="controls-left">
        <button id="btn-capture" class="btn-action" title="Capture/Record Scene">
            <span class="btn-text">Capture</span>
             <span class="btn-icon">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.33101 2.66602C9.57154 2.66601 9.80759 2.73107 10.0141 2.85431C10.2207 2.97754 10.3901 3.15435 10.5043 3.36602L10.8283 3.96602C10.9426 4.17768 11.112 4.35449 11.3185 4.47772C11.5251 4.60096 11.7611 4.66602 12.0017 4.66602H13.333C13.6866 4.66602 14.0258 4.80649 14.2758 5.05654C14.5259 5.30659 14.6663 5.64573 14.6663 5.99935V11.9993C14.6663 12.353 14.5259 12.6921 14.2758 12.9422C14.0258 13.1922 13.6866 13.3327 13.333 13.3327H2.66634C2.31272 13.3327 1.97358 13.1922 1.72353 12.9422C1.47348 12.6921 1.33301 12.353 1.33301 11.9993V5.99935C1.33301 5.64573 1.47348 5.30659 1.72353 5.05654C1.97358 4.80649 2.31272 4.66602 2.66634 4.66602H3.99767C4.23796 4.66603 4.47377 4.60111 4.6802 4.47813C4.88662 4.35514 5.05597 4.17866 5.17034 3.96735L5.49634 3.36468C5.61071 3.15337 5.78007 2.97689 5.98649 2.8539C6.19291 2.73092 6.42873 2.666 6.66901 2.66602H9.33101Z" stroke="currentColor" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7.99967 10.666C9.10424 10.666 9.99967 9.77059 9.99967 8.66602C9.99967 7.56145 9.10424 6.66602 7.99967 6.66602C6.89511 6.66602 5.99967 7.56145 5.99967 8.66602C5.99967 9.77059 6.89511 10.666 7.99967 10.666Z" stroke="currentColor" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
        </button>
        
        <div class="nav-arrows-group">
            <button id="btn-play-previous" class="btn-action" title="Animate to Previous Scene">
                <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g filter="url(#filter0_d_2264_5655)">
                    <path d="M3.875 7.375L0.375 3.875L3.875 0.375" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                    </g>
                    <defs>
                    <filter id="filter0_d_2264_5655" x="0" y="0" width="4.25" height="8.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                    <feOffset dy="0.5"/>
                    <feComposite in2="hardAlpha" operator="out"/>
                    <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
                    <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5655"/>
                    <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5655" result="shape"/>
                    </filter>
                    </defs>
                    </svg>
            </button>
            <button id="btn-play-next" class="btn-action" title="Animate to Next Scene">
                <svg width="5" height="9" viewBox="0 0 5 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g filter="url(#filter0_d_2264_5658)">
                    <path d="M0.375 7.375L3.875 3.875L0.375 0.375" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                    </g>
                    <defs>
                    <filter id="filter0_d_2264_5658" x="0" y="0" width="4.25" height="8.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                    <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                    <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                    <feOffset dy="0.5"/>
                    <feComposite in2="hardAlpha" operator="out"/>
                    <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
                    <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5658"/>
                    <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5658" result="shape"/>
                    </filter>
                    </defs>
                    </svg>
            </button>
        </div>
        
        <button id="btn-play-all" class="btn-action" title="Play All Scenes">
            <span class="btn-text">Play</span>
            <!-- Play Icon -->
            <span class="btn-icon icon-play-svg">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3.33398 3.33373C3.33391 3.09912 3.39575 2.86865 3.51324 2.66559C3.63073 2.46252 3.79972 2.29406 4.00315 2.17719C4.20658 2.06033 4.43724 1.99921 4.67184 2.00001C4.90645 2.0008 5.13669 2.06349 5.33932 2.18173L13.3373 6.84706C13.5392 6.96418 13.7067 7.13223 13.8233 7.3344C13.9398 7.53657 14.0013 7.76579 14.0015 7.99915C14.0017 8.23252 13.9406 8.46184 13.8244 8.66422C13.7082 8.86659 13.541 9.03493 13.3393 9.1524L5.33932 13.8191C5.13669 13.9373 4.90645 14 4.67184 14.0008C4.43724 14.0016 4.20658 13.9405 4.00315 13.8236C3.79972 13.7067 3.63073 13.5383 3.51324 13.3352C3.39575 13.1321 3.33391 12.9017 3.33398 12.6671V3.33373Z" stroke="currentColor" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
             <!-- Stop Icon -->
            <span class="btn-icon icon-stop-svg d-none">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.6667 2H3.33333C2.59695 2 2 2.59695 2 3.33333V12.6667C2 13.403 2.59695 14 3.33333 14H12.6667C13.403 14 14 13.403 14 12.6667V3.33333C14 2.59695 13.403 2 12.6667 2Z" stroke="currentColor" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
        </button>
        
        <button id="btn-hide-paths" class="btn-action" title="Show/Hide all path visualizations in Figma">
            <span class="btn-text">Show Paths</span>
            <span class="btn-icon icon-paths-show">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6 12.6673C6 13.7719 5.10457 14.6673 4 14.6673C2.89543 14.6673 2 13.7719 2 12.6673C2 11.5627 2.89543 10.6673 4 10.6673C5.10457 10.6673 6 11.5627 6 12.6673ZM6 12.6673H11.6667C12.2855 12.6673 12.879 12.4215 13.3166 11.9839C13.7542 11.5463 14 10.9528 14 10.334C14 9.71515 13.7542 9.12165 13.3166 8.68407C12.879 8.24648 12.2855 8.00065 11.6667 8.00065H4.33333C3.7145 8.00065 3.121 7.75482 2.68342 7.31723C2.24583 6.87965 2 6.28616 2 5.66732C2 5.04848 2.24583 4.45499 2.68342 4.0174C3.121 3.57982 3.7145 3.33398 4.33333 3.33398H10M10 3.33398C10 4.43855 10.8954 5.33398 12 5.33398C13.1046 5.33398 14 4.43855 14 3.33398C14 2.22941 13.1046 1.33398 12 1.33398C10.8954 1.33398 10 2.22941 10 3.33398Z" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

            </span>
             <!-- Paths Hidden Icon (same as show for now, but will likely be toggled with opacity) -->
             <span class="btn-icon icon-paths-hide d-none">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0_2396_20557)">
                    <path d="M5.99967 12.6673C5.99967 13.7719 5.10424 14.6673 3.99967 14.6673C2.8951 14.6673 1.99967 13.7719 1.99967 12.6673C1.99967 11.5627 2.8951 10.6673 3.99967 10.6673C5.10424 10.6673 5.99967 11.5627 5.99967 12.6673ZM5.99967 12.6673H11.6663C11.933 12.6673 12.2663 12.6007 12.533 12.534M3.46634 3.46732C2.96602 3.67248 2.55176 4.04635 2.29422 4.52515C2.03667 5.00395 1.95178 5.55803 2.05404 6.0929C2.15629 6.62777 2.43935 7.1103 2.85495 7.4582C3.27054 7.8061 3.79292 7.99781 4.33301 8.00065H7.99967M1.33301 1.33398L14.6663 14.6673M13.9997 10.2007C13.9678 9.62755 13.7257 9.08633 13.3199 8.68046C12.914 8.27459 12.3728 8.03256 11.7997 8.00065M9.99967 3.33398H7.13301M9.99967 3.33398C9.99967 4.43855 10.8951 5.33398 11.9997 5.33398C13.1042 5.33398 13.9997 4.43855 13.9997 3.33398C13.9997 2.22941 13.1042 1.33398 11.9997 1.33398C10.8951 1.33398 9.99967 2.22941 9.99967 3.33398Z" stroke="black" style="stroke:black;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
                    </g>
                    <defs>
                    <clipPath id="clip0_2396_20557">
                    <rect width="16" height="16" fill="white" style="fill:white;fill-opacity:1;"/>
                    </clipPath>
                    </defs>
                </svg>

            </span>
        </button>
        <button id="btn-toggle-mode" class="btn-action" title="Toggle Plugin Mode">
            <span id="mode-icon-span"></span>
        </button>
        <button id="btn-settings" class="btn-action" title="Settings/Scene List">
            <svg width="15" height="16" viewBox="0 0 15 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g filter="url(#filter0_d_2264_5571_static)">
                <path d="M6.675 6.164L3.875 1.313M6.675 8.586L3.875 13.437M7.375 14.375V12.975M7.375 12.975C10.4678 12.975 12.975 10.4678 12.975 7.375C12.975 4.28221 10.4678 1.775 7.375 1.775M7.375 12.975C4.28221 12.975 1.775 10.4678 1.775 7.375M7.375 0.375V1.775M7.375 1.775C4.28221 1.775 1.775 4.28221 1.775 7.375M8.775 7.375H14.375M8.775 7.375C8.775 8.1482 8.1482 8.775 7.375 8.775C6.6018 8.775 5.975 8.1482 5.975 7.375C5.975 6.6018 6.6018 5.975 7.375 5.975C8.1482 5.975 8.775 6.6018 8.775 7.375ZM10.875 13.437L10.175 12.226M10.875 1.313L10.175 2.524M0.375 7.375H1.775M13.437 10.875L12.226 10.175M13.437 3.875L12.226 4.575M1.313 10.875L2.524 10.175M1.313 3.875L2.524 4.575" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
                </g>
                <defs>
                <filter id="filter0_d_2264_5571_static" x="0" y="0" width="14.75" height="15.25" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                <feOffset dy="0.5"/>
                <feComposite in2="hardAlpha" operator="out"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5571"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5571" result="shape"/>
                </filter>
                </defs>
            </svg>
        </button>
    </div>
</header>

<div class="hidden-icons">
    <!-- Icon for Minify (Collapse) - Used in Horizontal Mode -->
    <svg id="icon-minify" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_2264_5581_min)">
        <path d="M6.79167 4.45833L10.875 0.375M6.79167 4.45833H10.2917M6.79167 4.45833V0.958333M0.375 10.875L4.45833 6.79167M4.45833 6.79167H0.958333M4.45833 6.79167V10.2917" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round" shape-rendering="crispEdges"/>
        </g>
        <defs>
        <filter id="filter0_d_2264_5581_min" x="0" y="0" width="11.25" height="11.75" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dy="0.5"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.5 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2264_5581_min"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2264_5581_min" result="shape"/>
        </filter>
        </defs>
    </svg>
    
    <!-- Icon for Expand - Used in Vertical Mode -->
    <svg id="icon-expand" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M8.75 8.75L12.25 12.25M12.25 12.25V9.33333M12.25 12.25H9.33333M8.75 5.25L12.25 1.75M12.25 1.75V4.66667M12.25 1.75H9.33333M1.75 9.33333V12.25M1.75 12.25H4.66667M1.75 12.25L5.25 8.75M1.75 4.66667V1.75M1.75 1.75H4.66667M1.75 1.75L5.25 5.25" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>

    

</div>
<div id="expanded-panel" class="collapsed">
    
    <div id="scene-list-view">
        <div class="setting-group">
            <div id="scene-list"></div>
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.25" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clapperboard-icon lucide-clapperboard"><path d="M20.2 6 3 11l-.9-2.4c-.3-1.1.3-2.2 1.3-2.5l13.5-4c1.1-.3 2.2.3 2.5 1.3Z"/><path d="m6.2 5.3 3.1 3.9"/><path d="m12.4 3.4 3.1 4"/><path d="M3 11h18v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"/></svg></div>
                <div class="empty-state-title">You have no scenes</div>
                <div class="empty-state-message">Pan, move, and zoom to wherever you want. Capture, customize, play, and enjoy.</div>
                <button class="empty-state-cta" onclick="document.getElementById('btn-capture').click()">Capture Scene</button>
            </div>
        </div>
    </div>
    
    <div id="config-view">
        <div class="setting-group">
            <h3>Project Manager</h3>
            <div class="project-manager">
                <input type="text" id="project-name-input" value="Default Project" placeholder="Enter Project Name">
                <div class="project-buttons">
                    <button id="btn-save-project">Save Project</button>
                    <button id="btn-load-project">Load Project</button>
                    <button id="btn-clear-scenes">Clear All Scenes</button>
                </div>
            </div>
        </div>
    
        <div class="setting-group">
            <h3>General Settings</h3>
            
            <div class="control-group plugin-mode">
                <label for="plugin-mode-select">Plugin Mode</label>
                <select id="plugin-mode-select">
                    <option value="horizontal">Wide/Horizontal (Screen Recording)</option>
                    <option value="vertical">Vertical Medium (Sidebar)</option>
                    <option value="mini">Vertical Mini (Icon Only)</option>
                </select>
            </div>

            <div class="size-controls">
                <div class="control-group">
                    <label>Wide Width</label>
                    <input type="number" id="default-width-input" min="335" max="1000" value="335">
                </div>
                <div class="control-group">
                    <label>Wide Height</label>
                    <input type="number" id="default-height-input" min="300" max="1000" value="400">
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="arc-enabled-checkbox">
                <label for="arc-enabled-checkbox">Enable Arc Path (Curved Camera Move)</label>
            </div>
        </div>
    </div>

</div>

<script>
  let scenes = [];
  let currentSceneIndex = 0; 
  let pluginMode = 'horizontal'; 
  let currentView = 'collapsed'; // Initial state should be 'collapsed'
  let is_playing = false; // Flag to track if the "Play All" sequence is running
  let animation_frame_id = null; // Holds the requestAnimationFrame ID for cancellation
// ----------------------------------
  
  let defaultWideWidth = 335;
  let defaultWideHeight = 400; 
  let isArcEnabled = true;

  let currentProjectName = 'motionDirectorDefaultProject';
  const DEFAULT_PROJECT_KEY = 'motionDirectorDefaultProject';

  const HORIZONTAL_MIN_HEIGHT = 40; 
  // Adjusted height to fit 6 buttons x 32px + gaps/padding
  const VERTICAL_MINI_HEIGHT = 208; 
  const VERTICAL_MEDIUM_HEIGHT = 176;
  
  const NEWTON_ITERATIONS = 4;
  const NEWTON_MIN_TOLERANCE = 0.001;
  const MID_ARC_FACTOR = 0.05; 
  
  // --- 1. CORE MATH FUNCTIONS ---
  function A(aA1, aA2) { return 1.0 - 3.0 * aA2 + 3.0 * aA1; }
  function B(aA1, aA2) { return 3.0 * aA2 - 6.0 * aA1; }
  function C(aA1)      { return 3.0 * aA1; }
  function CalcBezier(aA1, aA2, aT) { return ((A(aA1, aA2) * aT + B(aA1, aA2)) * aT + C(aA1)) * aT; }
  function GetSlope(aA1, aA2, aT) { return 3.0 * A(aA1, aA2) * aT * aT + 2.0 * B(aA1, aA2) * aT + C(aA1); }
  function GetTForX(aX, aA1, aA2) {
      let aGuessT = aX;
      for (let i = 0; i < NEWTON_ITERATIONS; ++i) {
          const currentX = CalcBezier(aA1, aA2, aGuessT) - aX;
          if (Math.abs(currentX) < NEWTON_MIN_TOLERANCE) return aGuessT;
          const currentSlope = GetSlope(aA1, aA2, aGuessT);
          if (Math.abs(currentSlope) < NEWTON_MIN_TOLERANCE) return aGuessT;
          aGuessT -= currentX / currentSlope;
      }
      return aGuessT;
  }
  function cubicBezier(t, x1, y1, x2, y2) {
      if (t === 0 || t === 1) return t;
      return CalcBezier(y1, y2, GetTForX(t, x1, x2));
  }
  function getEasing(t, easing, bezierPoints) {
    if (easing === 'custom' && bezierPoints && bezierPoints.length === 4) {
        const [x1, y1, x2, y2] = bezierPoints;
        const cx1 = Math.max(0, Math.min(1, parseFloat(x1)));
        const cy1 = parseFloat(y1);
        const cx2 = Math.max(0, Math.min(1, parseFloat(x2)));
        const cy2 = parseFloat(y2);
        return cubicBezier(t, cx1, cy1, cx2, cy2);
    }
    
    // Easing presets using cubic-bezier curves
    // Note: Avoid extreme overshoot values for camera - they cause shaking
    switch (easing) {
      // Original presets - smooth and safe
      case 'snap': return 1 - Math.pow(1 - t, 4); 
      case 'smooth': return cubicBezier(t, 0.25, 0.1, 0.25, 1);
      case 'linear': return t;
      
      // Standard CSS-like easings - safe for camera
      case 'ease': return cubicBezier(t, 0.25, 0.1, 0.25, 1);
      case 'ease-in': return cubicBezier(t, 0.42, 0, 1, 1);
      case 'ease-out': return cubicBezier(t, 0, 0, 0.58, 1);
      case 'ease-in-out': return cubicBezier(t, 0.42, 0, 0.58, 1);
      
      // Back easings (moderate overshoot - smoothing will soften)
      case 'ease-in-back': return cubicBezier(t, 0.6, -0.2, 0.735, 0.045);
      case 'ease-out-back': return cubicBezier(t, 0.175, 0.885, 0.32, 1.2);
      case 'ease-in-out-back': return cubicBezier(t, 0.68, -0.4, 0.265, 1.4);
      
      // Exponential easings - dramatic but safe
      case 'ease-in-expo': return cubicBezier(t, 0.95, 0.05, 0.795, 0.035);
      case 'ease-out-expo': return cubicBezier(t, 0.19, 1, 0.22, 1);
      
      // Circular easings - smooth curves
      case 'ease-in-circ': return cubicBezier(t, 0.6, 0.04, 0.98, 0.335);
      case 'ease-out-circ': return cubicBezier(t, 0.075, 0.82, 0.165, 1);
      
      // Spring - visible bounce
      case 'spring': return cubicBezier(t, 0.175, 0.885, 0.32, 1.15);
      
      default: return t;
    }
  }




  const MAX_ARC_OFFSET = 2000;

  function calculateArcControlPoint(start, end) {
      const dx = end.x - start.x;
      const dy = end.y - start.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      if (distance < 100) return { xc: (start.x + end.x) / 2, yc: (start.y + end.y) / 2 };

      const mx = (start.x + end.x) / 2;
      const my = (start.y + end.y) / 2;
      const nx = -dy;
      const ny = dx;
      const normLength = Math.sqrt(nx * nx + ny * ny);
      
      const calculatedOffset = distance * MID_ARC_FACTOR;
      const clampedOffset = Math.min(calculatedOffset, MAX_ARC_OFFSET);
      const scale = clampedOffset / normLength;

      const xc = mx + nx * scale;
      const yc = my + ny * scale;

      return { xc, yc };
  }


  // --- 2. PERSISTENCE & PROJECT MANAGEMENT ---

  function saveProject() {
      const dataToSave = {
          scenes: scenes,
          pluginMode: pluginMode,
          defaultWideWidth: defaultWideWidth,
          defaultWideHeight: defaultWideHeight,
          isArcEnabled: isArcEnabled,
          currentView: currentView // Save the current logical view state
      };
      parent.postMessage({ pluginMessage: { type: 'set-project', name: currentProjectName, data: dataToSave } }, '*');
  }

  function loadProject(projectName) {
      currentProjectName = (projectName.trim() || DEFAULT_PROJECT_KEY).replace(/[^a-zA-Z0-9]/g, '_');
      document.getElementById('project-name-input').value = currentProjectName;
      parent.postMessage({ pluginMessage: { type: 'get-project', name: currentProjectName } }, '*');
  }

  function initializeData(data, projectName) {
      currentProjectName = projectName;
      document.getElementById('project-name-input').value = projectName === DEFAULT_PROJECT_KEY ? "Default Project" : projectName;

      if (data) {
          if (data.scenes && Array.isArray(data.scenes)) {
              scenes = data.scenes;
              scenes.forEach((s, i) => {
                  if (!s.name || s.name.startsWith("Scene ")) {
                      s.name = `Scene ${i + 1}`;
                  }
                  if (!s.customControlPoint) {
                    s.customControlPoint = null;
                  }
                  if (!s.id) {
                      s.id = Date.now() + Math.random(); // Ensure ID exists
                  }
              });
          }
          defaultWideWidth = data.defaultWideWidth || 335;
          defaultWideHeight = data.defaultWideHeight || 400;
          isArcEnabled = data.isArcEnabled !== undefined ? data.isArcEnabled : true;
          
          const modeToLoad = data.pluginMode || 'horizontal'; 
          
          document.getElementById('default-width-input').value = defaultWideWidth;
          document.getElementById('default-height-input').value = defaultWideHeight;
          document.getElementById('arc-enabled-checkbox').checked = isArcEnabled;
          document.getElementById('plugin-mode-select').value = modeToLoad; 
          
          // Set the mode which handles the initial sizing
          setMode(modeToLoad, false); 
          
          // NEW: Auto-expand logic (Targeted requirement)
          if (modeToLoad === 'horizontal') {
              // Always show scenes view (will show empty state if no scenes)
              setPluginView('scenes', false); 
          }
          // Note: Vertical mode is always handled as 'scenes' via setMode
          
          renderList();
      } else {
          scenes = [];
          defaultWideWidth = 335;
          defaultWideHeight = 400;
          isArcEnabled = true;
          setMode('horizontal', false); 
          setPluginView('scenes', false); // Show empty state if no data
          renderList();
      }
  }

  document.getElementById('project-name-input').onchange = (e) => {
    currentProjectName = (e.target.value.trim() || "Default Project").replace(/[^a-zA-Z0-9]/g, '_');
    e.target.value = currentProjectName;
  };

  document.getElementById('btn-save-project').onclick = () => {
    saveProject();
    alert(`Project "${currentProjectName}" saved!`);
  };

  document.getElementById('btn-load-project').onclick = () => {
    const name = document.getElementById('project-name-input').value;
    loadProject(name);
  };
  
  document.getElementById('btn-clear-scenes').onclick = () => {
    if (confirm("Are you sure you want to clear ALL scenes in the current session? This cannot be undone.")) {
      // Delete all paths in Figma
      parent.postMessage({ pluginMessage: { type: 'hide-paths' } }, '*');
      
      scenes = [];
      currentSceneIndex = 0; 
      renderList();
      saveProject();
      setPluginView('collapsed', true); // Collapse after clearing scenes
    }
  };


  // --- General Settings Handlers ---
  
  document.getElementById('default-width-input').onchange = (e) => {
      const newWidth = parseInt(e.target.value) || 335;
      defaultWideWidth = Math.max(335, Math.min(1000, newWidth));
      e.target.value = defaultWideWidth;
      saveProject(); 
      if (pluginMode === 'horizontal') {
           const height = (currentView === 'collapsed') ? HORIZONTAL_MIN_HEIGHT : defaultWideHeight;
           setPluginSize(defaultWideWidth, height);
      }
  };

  document.getElementById('default-height-input').onchange = (e) => {
      const newHeight = parseInt(e.target.value) || 400;
      defaultWideHeight = Math.max(300, Math.min(1000, newHeight));
      e.target.value = defaultWideHeight;
      saveProject(); 
      if (pluginMode === 'horizontal' && currentView !== 'collapsed') {
          setPluginSize(defaultWideWidth, defaultWideHeight);
      }
  };

  document.getElementById('arc-enabled-checkbox').onchange = (e) => {
      isArcEnabled = e.target.checked;
      saveProject(); 
  };
  
  // Track visibility state of paths
  let pathsVisible = false;
      document.getElementById('btn-hide-paths').onclick = () => {
    const btn = document.getElementById('btn-hide-paths');
    const iconShow = btn.querySelector('.icon-paths-show');
    const iconHide = btn.querySelector('.icon-paths-hide');
    const textSpan = btn.querySelector('.btn-text');

    if (pathsVisible) {
      parent.postMessage({ pluginMessage: { type: 'hide-paths' } }, '*');
      textSpan.textContent = 'Show Paths';
      
      // Update Icons
      if (iconShow) iconShow.classList.remove('d-none');
      if (iconHide) iconHide.classList.add('d-none');

      pathsVisible = false;
    } else {
      // Show paths for all scenes that have them
      scenes.forEach((scene, index) => {
        if (index < scenes.length - 1) {
          // Trigger path visualization for each scene pair
          const data = getPathData(index);
          if (data) {
            data.sceneIndex = index;
            parent.postMessage({ pluginMessage: { type: 'draw-path', pathData: data } }, '*');
          }
        }
      });
      textSpan.textContent = 'Hide Paths';
      
      // Update Icons
      if (iconShow) iconShow.classList.add('d-none');
      if (iconHide) iconHide.classList.remove('d-none');

      pathsVisible = true;
    }
  };


  // --- 3. SCENE MANAGEMENT ---
  
  function parseBezierString(bezierString) {
      if (!bezierString) return [];
      return bezierString.split(',').map(s => s.trim()).filter(s => s.length > 0).map(parseFloat);
  }
  
  function handleUpdateScene(index, prop, value) {
      scenes[index][prop] = value;
      saveProject(); 
  }

  function handleUpdateSceneView(index) {
      // Send a request to capture the current view, but tag it with the index we want to update
      parent.postMessage({ pluginMessage: { type: 'capture-scene', updateIndex: index } }, '*');
  }
  
  function handlePlayScene(index) {
    if (is_playing) return; 
    
    if (scenes.length < 2) return;
    
    // Target scene is the one being played TO
    const targetScene = scenes[index]; 
    
    // Path settings are defined on the scene BEFORE the target scene in the sequence.
    const pathSettingsIndex = (index === 0) ? scenes.length - 1 : index - 1; 
    
    parent.postMessage({ pluginMessage: { type: 'capture-scene', targetScene: targetScene, pathSettingsIndex: pathSettingsIndex } }, '*');
    
    currentSceneIndex = index; // Set current index to the scene we just animated TO
    renderList(); // Refresh the list to apply the active class
}
  
  function handleDeleteScene(index) {
      if (confirm("Delete this scene?")) {
          // Delete the path associated with this scene
          parent.postMessage({ pluginMessage: { type: 'delete-scene-path', sceneIndex: index } }, '*');
          
          scenes.splice(index, 1); 
          if (currentSceneIndex >= scenes.length) {
              currentSceneIndex = scenes.length - 1; 
          }
          renderList();
          saveProject();
          
          if (scenes.length === 0) {
              setPluginView('scenes', true); // Show empty state
          }
      }
  }

  // --- 4. UI AND MODE CONTROL (FIXED/UPDATED) ---
  let targetViewPayload = null; 

  function setPluginSize(width, height) {
      document.body.style.width = `${width}px`;
      document.body.style.height = `${height}px`;
      parent.postMessage({ pluginMessage: { type: 'resize', width, height } }, '*');
  }

  /* 
   * Toggles: Horizontal -> Vertical (72px) -> Mini (34px) -> Horizontal
   */
  const VERTICAL_WIDTH = 72;
  const MINI_WIDTH = 34;
  
  function setMode(mode, shouldSave = true) { 
      pluginMode = mode;
      // Remove all mode classes then add the active one
      document.body.classList.remove('mode-horizontal', 'mode-vertical', 'mode-mini');
      document.body.classList.add(`mode-${mode}`);
      
      const settingsButton = document.getElementById('btn-settings');
      const modeIconSpan = document.getElementById('mode-icon-span');
      
      if (mode === 'horizontal') {
          settingsButton.style.display = 'flex';
          // Horizontal -> Show "Minimize" icon
          modeIconSpan.innerHTML = document.getElementById('icon-minify').outerHTML;

          if (currentView === 'collapsed') {
             setPluginSize(defaultWideWidth, HORIZONTAL_MIN_HEIGHT);
             document.getElementById('expanded-panel').style.display = 'none';
          } else {
             setPluginSize(defaultWideWidth, defaultWideHeight);
             document.getElementById('expanded-panel').style.display = 'flex';
          }
      } else if (mode === 'vertical' || mode === 'mini') {
          document.getElementById('expanded-panel').style.display = 'none'; 
          settingsButton.style.display = 'none'; 
          currentView = 'scenes'; 

          // Set width based on mode
          const width = (mode === 'mini') ? MINI_WIDTH : VERTICAL_WIDTH;
          // Set height based on mode: Mini needs more transparency/space for stack (208), Medium is shorter (176)

          const height = (mode === 'mini') ? VERTICAL_MINI_HEIGHT : VERTICAL_MEDIUM_HEIGHT;
          setPluginSize(width, height);
          
          // Icon Logic: Vertical -> Minimize, Mini -> Expand
          if (mode === 'vertical') {
              modeIconSpan.innerHTML = document.getElementById('icon-minify').outerHTML;
          } else {
              modeIconSpan.innerHTML = document.getElementById('icon-expand').outerHTML;
          }
      }
      
      document.getElementById('plugin-mode-select').value = mode;

      if (shouldSave) {
          saveProject(); 
      }
  }

  /**
   * Toggles between the Scene List View, Configuration View, or Collapsed state
   * and updates the plugin size and button icon. (UPDATED for icon change)
   */
  function setPluginView(viewName, shouldSave = true) {
      currentView = viewName;
      const expandedPanel = document.getElementById('expanded-panel');
      const sceneView = document.getElementById('scene-list-view');
      const configView = document.getElementById('config-view');
      const settingsButton = document.getElementById('btn-settings');

      // 1. Logic for Collapsed State
      if (viewName === 'collapsed') {
          expandedPanel.style.display = 'none';
          settingsButton.style.color = 'var(--color-text-faded)'; 

          if (pluginMode === 'horizontal') {
              setPluginSize(defaultWideWidth, HORIZONTAL_MIN_HEIGHT); // Reset to collapsed size
          }
          
      } else {
          // 2. Logic for Expanded States ('scenes' or 'config')
          expandedPanel.style.display = 'flex'; 
          
          if (viewName === 'config') {
              sceneView.style.display = 'none';
              configView.style.display = 'flex';
              settingsButton.style.color = 'var(--color-accent-blue)'; 
              
          } else { // 'scenes' view
              sceneView.style.display = 'flex';
              configView.style.display = 'none';
              settingsButton.style.color = 'var(--color-text-faded)'; 
          }
          
          if (pluginMode === 'horizontal') {
              setPluginSize(defaultWideWidth, defaultWideHeight); // Ensure expanded size
          }
      }

      if (shouldSave) {
          saveProject();
      }
  }

  
  /**
   * Toggles the Expanded/Collapsed state (Horizontal Mode) or the View (Scene/Config).
   */
  document.getElementById('btn-settings').onclick = () => {
    if (pluginMode === 'vertical') return; // Settings button is hidden in vertical mode

    if (currentView === 'collapsed') {
        setPluginView('scenes'); // Collapsed -> Scenes
    } else if (currentView === 'scenes') {
        setPluginView('config'); // Scenes -> Config
    } else { // currentView === 'config'
        setPluginView('collapsed'); // Config -> Collapsed
    }
  };
  
  /**
   * Toggles between Horizontal (Wide) -> Vertical (Medium) -> Vertical (Mini)
   */
  document.getElementById('btn-toggle-mode').onclick = () => {
    let newMode = 'horizontal';
    if (pluginMode === 'horizontal') {
        newMode = 'vertical';
    } else if (pluginMode === 'vertical') {
        newMode = 'mini';
    } else {
        newMode = 'horizontal';
    }
    setMode(newMode);
  };


  document.getElementById('plugin-mode-select').onchange = (e) => {
      setMode(e.target.value);
  };

  window.onload = () => {
      // Need to set the initial icon state before fetching data 
      
      // Start with expanded panel showing scene list
      setPluginView('scenes');
      
      loadProject("Default Project");
  }


  // --- Path Visualization and Editing ---

  function getPathData(sceneIndex) {
    if (sceneIndex === scenes.length - 1 || scenes.length < 2) {
        return null;
    }

    const startScene = scenes[sceneIndex];
    const endScene = scenes[sceneIndex + 1];

    if (!startScene || !endScene) return null;

    const start = startScene.view;
    const end = endScene.view;
    
    let controlPoint = startScene.customControlPoint;

    if (!controlPoint) {
        const defaultControl = calculateArcControlPoint(start, end);
        controlPoint = { x: defaultControl.xc, y: defaultControl.yc };
    }

    return {
        start: { x: start.x, y: start.y },
        end: { x: end.x, y: end.y },
        control: controlPoint,
        isArcEnabled: isArcEnabled,
        isCustom: !!startScene.customControlPoint
    };
  }



  // ========================================
  // LOADING STATE HELPERS
  // ========================================
  
  function showLoading(message = 'Loading...') {
      const overlay = document.getElementById('loading-overlay');
      const messageEl = document.getElementById('loading-message');
      messageEl.textContent = message;
      overlay.style.display = 'flex';
  }

  function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = 'none';
  }

  // ========================================
  // SCENE MANAGEMENT FUNCTIONS
  // ========================================
  
  function handleVisualizePath(sceneIndex) {
    const data = getPathData(sceneIndex);
    if (!data) {
        alert(scenes.length < 2 ? "Need at least two scenes." : "Cannot visualize path from the last scene.");
        return;
    }

    // Include sceneIndex in pathData for unique naming
    data.sceneIndex = sceneIndex;
    parent.postMessage({ pluginMessage: { type: 'draw-path', pathData: data } }, '*');
  }

  function handleHidePath(sceneIndex) {
    parent.postMessage({ pluginMessage: { type: 'hide-path', sceneIndex: sceneIndex } }, '*');
  }

  function handleResetPath(sceneIndex) {
    if (sceneIndex === scenes.length - 1 || scenes.length < 2) return;
    
    // Clear the custom control point, forcing recalculation to default
    scenes[sceneIndex].customControlPoint = null;
    saveProject();
    
    // Redraw the path with default control point
    handleVisualizePath(sceneIndex);
    renderList();
  }

  function handleRecalculatePath(sceneIndex) {
    if (sceneIndex === scenes.length - 1 || scenes.length < 2) return;
    
    parent.postMessage({ pluginMessage: { type: 'get-control-point', sceneIndex: sceneIndex } }, '*');
  }

  // --- 5. RENDER LIST ---
  
  let draggedItemIndex = null;

  function handleDragStart(e, index) {
      draggedItemIndex = index;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
  }

  function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
  }

  function handleDrop(e, index) {
      e.preventDefault();
      if (draggedItemIndex === null || draggedItemIndex === index) return;

      // Reorder array
      const itemToMove = scenes[draggedItemIndex];
      scenes.splice(draggedItemIndex, 1);
      scenes.splice(index, 0, itemToMove);
      
      // Update current index if needed
      if (currentSceneIndex === draggedItemIndex) {
          currentSceneIndex = index;
      } else if (currentSceneIndex > draggedItemIndex && currentSceneIndex <= index) {
          currentSceneIndex--;
      } else if (currentSceneIndex < draggedItemIndex && currentSceneIndex >= index) {
          currentSceneIndex++;
      }

      draggedItemIndex = null;
      renderList();
      saveProject();
  }

  function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedItemIndex = null;
  }

  // ========================================
  // ICON CONSTANTS (Global Scope)
  // ========================================
  
  const iconEye = `<svg width="10" height="11" viewBox="0 0 10 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.375 8.875C3.375 9.70343 2.70343 10.375 1.875 10.375C1.04657 10.375 0.375 9.70343 0.375 8.875C0.375 8.04657 1.04657 7.375 1.875 7.375C2.70343 7.375 3.375 8.04657 3.375 8.875ZM3.375 8.875H7.625C8.08913 8.875 8.53425 8.69063 8.86244 8.36244C9.19063 8.03425 9.375 7.58913 9.375 7.125C9.375 6.66087 9.19063 6.21575 8.86244 5.88756C8.53425 5.55937 8.08913 5.375 7.625 5.375H2.125C1.66087 5.375 1.21575 5.19063 0.887563 4.86244C0.559375 4.53425 0.375 4.08913 0.375 3.625C0.375 3.16087 0.559375 2.71575 0.887563 2.38756C1.21575 2.05937 1.66087 1.875 2.125 1.875H6.375M6.375 1.875C6.375 2.70343 7.04657 3.375 7.875 3.375C8.70343 3.375 9.375 2.70343 9.375 1.875C9.375 1.04657 8.70343 0.375 7.875 0.375C7.04657 0.375 6.375 1.04657 6.375 1.875Z" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconEyeOff = `<svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.875 8.875C3.875 9.70343 3.20343 10.375 2.375 10.375C1.54657 10.375 0.875 9.70343 0.875 8.875C0.875 8.04657 1.54657 7.375 2.375 7.375C3.20343 7.375 3.875 8.04657 3.875 8.875ZM3.875 8.875H8.125C8.325 8.875 8.575 8.825 8.775 8.775M1.975 1.975C1.59976 2.12887 1.28907 2.40927 1.09591 2.76837C0.902745 3.12747 0.839082 3.54303 0.915773 3.94419C0.992464 4.34534 1.20476 4.70724 1.51645 4.96816C1.82815 5.22908 2.21994 5.37287 2.625 5.375H5.375M0.375 0.375L10.375 10.375M9.875 7.025C9.85107 6.59518 9.66954 6.18926 9.36514 5.88486C9.06074 5.58046 8.65482 5.39893 8.225 5.375M6.875 1.875H4.725M6.875 1.875C6.875 2.70343 7.54657 3.375 8.375 3.375C9.20343 3.375 9.875 2.70343 9.875 1.875C9.875 1.04657 9.20343 0.375 8.375 0.375C7.54657 0.375 6.875 1.04657 6.875 1.875Z" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;

  const iconRefresh = `<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.375 4.875C0.375 3.68153 0.849106 2.53693 1.69302 1.69302C2.53693 0.849106 3.68153 0.375 4.875 0.375C6.13302 0.379733 7.34052 0.870612 8.245 1.745L9.375 2.875M9.375 2.875V0.375M9.375 2.875H6.875M9.375 4.875C9.375 6.06847 8.90089 7.21307 8.05698 8.05698C7.21307 8.90089 6.06847 9.375 4.875 9.375C3.61698 9.37027 2.40948 8.87939 1.505 8.005L0.375 6.875M0.375 6.875H2.875M0.375 6.875V9.375" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconPlay = `<svg width="9" height="10" viewBox="0 0 9 10" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.375 1.3753C0.374948 1.19934 0.421323 1.02649 0.509442 0.874191C0.597561 0.721893 0.724305 0.595541 0.876875 0.507894C1.02945 0.420247 1.20244 0.374408 1.37839 0.375006C1.55435 0.375603 1.72703 0.422616 1.879 0.511296L7.8775 4.0103C8.02888 4.09814 8.15456 4.22417 8.24197 4.3758C8.32938 4.52743 8.37547 4.69934 8.37562 4.87437C8.37577 5.04939 8.32998 5.22138 8.24284 5.37316C8.15569 5.52494 8.03023 5.65119 7.879 5.7393L1.879 9.2393C1.72703 9.32798 1.55435 9.37499 1.37839 9.37559C1.20244 9.37618 1.02945 9.33035 0.876875 9.2427C0.724305 9.15505 0.597561 9.0287 0.509442 8.8764C0.421323 8.7241 0.374948 8.55125 0.375 8.3753V1.3753Z" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconTrash = `<svg width="10" height="11" viewBox="0 0 10 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M8.375 2.375V9.375C8.375 9.64022 8.26964 9.89457 8.08211 10.0821C7.89457 10.2696 7.64022 10.375 7.375 10.375H2.375C2.10978 10.375 1.85543 10.2696 1.66789 10.0821C1.48036 9.89457 1.375 9.64022 1.375 9.375V2.375M0.375 2.375H9.375M2.875 2.375V1.375C2.875 1.10978 2.98036 0.85543 3.16789 0.667893C3.35543 0.480357 3.60978 0.375 3.875 0.375H5.875C6.14022 0.375 6.39457 0.480357 6.58211 0.667893C6.76964 0.85543 6.875 1.10978 6.875 1.375V2.375" stroke="white" stroke-opacity="0.5" style="stroke:white;stroke-opacity:0.5;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

  const iconDrag = `<svg width="6" height="11" viewBox="0 0 6 11" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M0.958333 5.625C1.2805 5.625 1.54167 5.36383 1.54167 5.04167C1.54167 4.7195 1.2805 4.45833 0.958333 4.45833C0.636167 4.45833 0.375 4.7195 0.375 5.04167C0.375 5.36383 0.636167 5.625 0.958333 5.625Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M0.958333 1.54167C1.2805 1.54167 1.54167 1.2805 1.54167 0.958333C1.54167 0.636167 1.2805 0.375 0.958333 0.375C0.636167 0.375 0.375 0.636167 0.375 0.958333C0.375 1.2805 0.636167 1.54167 0.958333 1.54167Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M0.958333 9.70833C1.2805 9.70833 1.54167 9.44717 1.54167 9.125C1.54167 8.80284 1.2805 8.54167 0.958333 8.54167C0.636167 8.54167 0.375 8.80284 0.375 9.125C0.375 9.44717 0.636167 9.70833 0.958333 9.70833Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4.45833 5.625C4.7805 5.625 5.04167 5.36383 5.04167 5.04167C5.04167 4.7195 4.7805 4.45833 4.45833 4.45833C4.13617 4.45833 3.875 4.7195 3.875 5.04167C3.875 5.36383 4.13617 5.625 4.45833 5.625Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4.45833 1.54167C4.7805 1.54167 5.04167 1.2805 5.04167 0.958333C5.04167 0.636167 4.7805 0.375 4.45833 0.375C4.13617 0.375 3.875 0.636167 3.875 0.958333C3.875 1.2805 4.13617 1.54167 4.45833 1.54167Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4.45833 9.70833C4.7805 9.70833 5.04167 9.44717 5.04167 9.125C5.04167 8.80284 4.7805 8.54167 4.45833 8.54167C4.13617 8.54167 3.875 8.80284 3.875 9.125C3.875 9.44717 4.13617 9.70833 4.45833 9.70833Z" stroke="white" style="stroke:white;stroke-opacity:1;" stroke-width="0.75" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`;

  // ========================================

// ========================================

function getSceneHTML(scene, index) {
    const pathSettingsIndex = index;
    const isLastScene = index === scenes.length - 1;

    const hasCustomPath = isLastScene || !!scenes[pathSettingsIndex].customControlPoint; 
    
    const pathControlsVisible = scene.pathControlsVisible || false;
    const eyeIcon = pathControlsVisible ? iconEyeOff : iconEye;
    
    // Generate Options for Easing Select
    const easingOptions = `
        <option value="custom">Custom Bezier</option>
        <optgroup label="Basic">
            <option value="linear">Linear</option>
            <option value="ease">Ease</option>
            <option value="ease-in">Ease In</option>
            <option value="ease-out">Ease Out</option>
            <option value="ease-in-out">Ease In-Out</option>
        </optgroup>
        <optgroup label="Dramatic">
            <option value="snap">Snap (Quart)</option>
            <option value="smooth">Smooth</option>
            <option value="ease-in-expo">Expo In</option>
            <option value="ease-out-expo">Expo Out</option>
        </optgroup>
        <optgroup label="Overshoot">
            <option value="ease-in-back">Back In</option>
            <option value="ease-out-back">Back Out</option>
            <option value="ease-in-out-back">Back In-Out</option>
            <option value="spring">Spring</option>
        </optgroup>
        <optgroup label="Circular">
            <option value="ease-in-circ">Circ In</option>
            <option value="ease-out-circ">Circ Out</option>
        </optgroup>
    `;

    return `
      <div class="scene-top-row">
          <div class="scene-name-group">
              <div class="drag-handle" title="Drag to reorder">${iconDrag}</div>
              <input type="text" class="scene-name-input" data-prop="name" id="name-${index}" value="${scene.name}">
          </div>
          <div class="actions">
              <div class="path-toggle-wrapper">
                  <button title="${pathControlsVisible ? 'Hide' : 'Show'} path" data-action="toggle-path" data-index="${index}">${eyeIcon}</button>
                  <div class="path-controls-popup" id="path-controls-${index}" style="display: ${pathControlsVisible ? 'flex' : 'none'};">
                      <button class="btn-visualize" data-action="recalculate" data-index="${index}" title="Update path">UPDATE</button>
                      <button class="btn-visualize" data-action="reset-path" data-index="${index}" title="Reset path">RESET</button>
                  </div>
              </div>
              <button title="Update scene with current view" data-action="update" data-index="${index}">${iconRefresh}</button>
              <button title="Play this scene" data-action="play" data-index="${index}">${iconPlay}</button>
              <button title="Delete scene" data-index="${index}" data-action="delete">${iconTrash}</button>
          </div>
      </div>
      
      <div class="scene-edit-row">
          <div class="control-group"><label>Dur</label><input type="number" class="duration-input" data-prop="duration" id="dur-${index}" value="${scene.duration}" min="100"></div>
          <div class="control-group"><label>Delay</label><input type="number" class="delay-input" data-prop="delay" id="delay-${index}" value="${scene.delay}" min="0"></div>
          
          <div class="control-group">
              <label>Ease</label>
              <select id="easing-${index}" data-prop="easing">
                  ${easingOptions}
              </select>
          </div>
      </div>
      
      <div class="bezier-row" id="bezier-row-${index}" style="display: ${scene.easing === 'custom' ? 'flex' : 'none'};">
          <label>Bezier (x1, y1, x2, y2)</label>
          <input type="text" data-prop="bezier" id="bezier-text-input-${index}" value="${scene.bezier}" placeholder="0.24, 0.61, 0.48, 1.0">
      </div>
    `;
}

function attachSceneListeners(li, index) {
    // Drag & Drop
    li.setAttribute('draggable', 'true');
    li.ondragstart = (e) => handleDragStart(e, index);
    li.ondragover = (e) => handleDragOver(e);
    li.ondrop = (e) => handleDrop(e, index);
    li.ondragend = (e) => handleDragEnd(e);

    // Inputs
    li.querySelectorAll('input').forEach(input => {
        input.onchange = (e) => {
            let value = e.target.value;
            const prop = e.target.dataset.prop;
            if (input.type === 'number') {
                value = parseInt(e.target.value) || 0;
            } else if (prop === 'name') {
                value = value.trim() || `Scene ${index + 1}`;
                e.target.value = value;
            }
            handleUpdateScene(index, prop, value);
        };
        // Prevent drag when interacting with inputs
        input.onmousedown = (e) => e.stopPropagation();
    });

    // Selects
    const easingSelect = li.querySelector(`#easing-${index}`);
    if (easingSelect) {
        easingSelect.value = scenes[index].easing; // Ensure value is set
        easingSelect.onchange = (e) => {
            handleUpdateScene(index, 'easing', e.target.value);
            const bezierRow = li.querySelector(`#bezier-row-${index}`);
            if (bezierRow) {
                bezierRow.style.display = e.target.value === 'custom' ? 'flex' : 'none';
            }
        };
    }

    // Buttons
    li.querySelectorAll('.actions button, .path-toggle-wrapper button').forEach(button => {
        button.onclick = (e) => {
            e.stopPropagation(); // Prevent drag
            const action = button.dataset.action;
            if (action === 'delete') handleDeleteScene(index);
            else if (action === 'play') handlePlayScene(index);
            else if (action === 'update') handleUpdateSceneView(index);
            else if (action === 'toggle-path') {
                 scenes[index].pathControlsVisible = !scenes[index].pathControlsVisible;
                 renderList(); // Re-render to show/hide popup
            }
            else if (action === 'recalculate') handleRecalculatePath(index);
            else if (action === 'reset-path') handleResetPath(index);
        };
    });
}

function renderList() {
    const list = document.getElementById('scene-list');
    
    // Map existing elements by ID
    const existingElements = new Map();
    Array.from(list.children).forEach(el => {
        if (el.dataset.id) existingElements.set(el.dataset.id, el);
    });

    const currentIds = new Set(scenes.map(s => String(s.id)));

    // 1. Remove deleted scenes (Animate Out)
    existingElements.forEach((el, id) => {
        if (!currentIds.has(id)) {
            // Native WAAPI Animation - Faster and Overlapping
            const animation = el.animate([
                { opacity: 1, height: el.offsetHeight + 'px', transform: 'scale(1)', marginBottom: '4px', padding: '4px', offset: 0 },
                { opacity: 0, height: el.offsetHeight + 'px', transform: 'scale(0.95)', marginBottom: '4px', padding: '4px', offset: 0.3 }, // Fade out start
                { opacity: 0, height: '0px', transform: 'scale(0.9)', marginBottom: '0px', padding: '0px', offset: 1 } // Collapse finish
            ], { duration: 300, easing: 'ease-out' }); // Reduced to 300ms
            
            animation.onfinish = () => el.remove();
        }
    });

    // 2. Add or Update scenes
    scenes.forEach((scene, index) => {
        let li = existingElements.get(String(scene.id));
        const isNew = !li;

        if (isNew) {
            li = document.createElement('div');
            li.dataset.id = scene.id;
            li.className = 'scene-item';
            
            // Set content
            li.innerHTML = getSceneHTML(scene, index);
            attachSceneListeners(li, index);
            
            // Append (will be reordered if needed)
            list.appendChild(li);
            
            // Native WAAPI Animate In
            li.animate([
                { opacity: 0, transform: 'translateY(20px) scale(0.95)' },
                { opacity: 1, transform: 'translateY(0) scale(1)' }
            ], { duration: 300, easing: 'cubic-bezier(0.2, 0.8, 0.2, 1)' });
            
        } else {
            // Existing: Move to correct position
            list.appendChild(li);
            
            // Update content
            li.innerHTML = getSceneHTML(scene, index);
            attachSceneListeners(li, index);
        }

        // Update active state
        const isActive = index === currentSceneIndex;
        if (isActive) li.classList.add('scene-item-active');
        else li.classList.remove('scene-item-active');
    });
    
    // 3. Handle Empty State Animation
    const emptyState = document.getElementById('empty-state');
    if (scenes.length === 0) {
        if (emptyState.style.display === 'none') {
            emptyState.style.display = 'flex';
            
            // Cancel any hiding animations
            emptyState.getAnimations().forEach(a => a.cancel());
            emptyState.style.opacity = '1';

            // Staggered Animation for Children
            Array.from(emptyState.children).forEach((child, i) => {
                child.animate([
                    { opacity: 0, transform: 'translateY(10px)' },
                    { opacity: 1, transform: 'translateY(0)' }
                ], {
                    duration: 600,
                    delay: i * 100, // Stagger delay
                    easing: 'ease-out',
                    fill: 'both'
                });
            });
        }
    } else {
        if (emptyState.style.display !== 'none') {
             // Cancel any existing animations to prevent conflicts
             emptyState.getAnimations().forEach(a => a.cancel());
             
             const animation = emptyState.animate([
                 { opacity: 1 },
                 { opacity: 0 }
             ], { duration: 200, easing: 'ease-out' });
             
             animation.onfinish = () => {
                 emptyState.style.display = 'none';
                 emptyState.style.opacity = '1'; // Reset for next time
             };
        }
    }
}
  // Toggle path visualization and controls
  function handleTogglePath(index) {
      const scene = scenes[index];
      const isVisible = scene.pathControlsVisible || false;
      
      if (isVisible) {
          // Hide path and controls
          handleHidePath(index);
          scene.pathControlsVisible = false;
      } else {
          // Check if we can visualize a path from this scene
          const pathData = getPathData(index);
          if (!pathData) {
              alert(scenes.length < 2 ? "Need at least two scenes to visualize a path." : "Cannot visualize path from the last scene.");
              return;
          }
          
          // Show path and controls
          handleVisualizePath(index);
          scene.pathControlsVisible = true;
      }
      saveProject();
      renderList(); // Re-render to update the buttons and icon
  }


  // --- 6. GLOBAL BUTTONS & ANIMATION ENGINE (FIXED LOGIC) ---
  
  document.getElementById('btn-capture').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'capture-scene' } }, '*');
  };
  
  function handlePlayNavigation(direction) {
    if (is_playing) return; 

    if (scenes.length < 2) {
        alert("Need at least two scenes for playback.");
        return;
    }

    // 1. Determine the target index (the scene we animate TO)
    let nextIndex = currentSceneIndex + direction;

    if (nextIndex < 0) {
        nextIndex = scenes.length - 1; 
    } else if (nextIndex >= scenes.length) {
        nextIndex = 0;
    }
    
    // 2. Determine the path settings index (the scene we animate FROM)
    let pathSettingsIndex;
    // Check for wrap-around case first
    if ((currentSceneIndex === 0 && nextIndex === scenes.length - 1) || 
        (currentSceneIndex === scenes.length - 1 && nextIndex === 0)) {
        pathSettingsIndex = scenes.length - 1;
    } else {
        pathSettingsIndex = Math.min(currentSceneIndex, nextIndex);
    } 
    
    // 3. Set the payload and send message to capture current view (start point)
    targetViewPayload = {
        targetScene: scenes[nextIndex],
        pathSettingsIndex: pathSettingsIndex
    };
    
    parent.postMessage({ pluginMessage: { type: 'capture-scene', ...targetViewPayload } }, '*');
    
    // 4. Update the tracker for the next click AND refresh the list
    currentSceneIndex = nextIndex;
    renderList(); // Refresh the list to apply the active class
}
  
  document.getElementById('btn-play-previous').onclick = () => {
    handlePlayNavigation(-1); 
  };
  
  document.getElementById('btn-play-next').onclick = () => {
    handlePlayNavigation(1);
  };


// Helper function to reset the button and state
function resetPlayButton() {
    is_playing = false;
    const playButton = document.getElementById('btn-play-all');
    const textSpan = playButton.querySelector('.btn-text');
    const iconPlay = playButton.querySelector('.icon-play-svg');
    const iconStop = playButton.querySelector('.icon-stop-svg');
    
    textSpan.textContent = 'Play';
    playButton.classList.remove('btn-stop');
    
    // Update Icons
    if (iconPlay) iconPlay.classList.remove('d-none');
    if (iconStop) iconStop.classList.add('d-none');
    
    // Cancel any pending animation frame
    if (animation_frame_id) {
        cancelAnimationFrame(animation_frame_id);
    }
}

// Function to handle the Stop action
function stopPlayback() {
    resetPlayButton();
}

async function startPlayback() {
    if (scenes.length < 2) {
        alert("Need at least two scenes for playback.");
        return;
    }
    
    // 1. Set Playing State and UI
    is_playing = true;
    const playButton = document.getElementById('btn-play-all');
    const textSpan = playButton.querySelector('.btn-text');
    const iconPlay = playButton.querySelector('.icon-play-svg');
    const iconStop = playButton.querySelector('.icon-stop-svg');

    textSpan.textContent = 'Stop';
    playButton.classList.add('btn-stop');
    
    // Update Icons
    if (iconPlay) iconPlay.classList.add('d-none');
    if (iconStop) iconStop.classList.remove('d-none');
    
    for (let i = 0; i < scenes.length; i++) {
        // Stop check inside the loop, handles early exit between scene transitions
        if (!is_playing) break; 
        
        const target = scenes[i];
        // The path settings are taken from the scene we just animated FROM. 
        // When going to scene i, the path settings used are from the previous scene (i-1).
        // For the first scene (i=0), the path settings should be from the last scene in the list (loop).
        const pathSettingsIndex = (i === 0) ? scenes.length - 1 : i - 1; 
        const pathScene = scenes[pathSettingsIndex];
        
        // STEP 1: Capture the starting point
        const currentView = await new Promise(resolve => {
            // Temporarily replace the global handler to capture the immediate response
            const tempHandler = (event) => {
                const msg = event.data.pluginMessage;
                if (msg && msg.type === 'scene-captured' && !msg.targetScene) {
                    window.onmessage = messageHandler; // Restore the global handler
                    resolve(msg.view);
                }
            };
            window.onmessage = tempHandler; 
            parent.postMessage({ pluginMessage: { type: 'capture-scene' } }, '*'); 
        });
        
        if (currentView) {
            const customControlPoint = pathScene ? pathScene.customControlPoint : null;
            const duration = pathScene.duration;
            const easing = pathScene.easing;
            const delay = pathScene.delay;
            const bezier = pathScene.bezier;

            // Wait for animation + delay to complete
            await animate(currentView, target.view, duration, easing, delay, bezier, customControlPoint, true);
        }
        
        // Stop check after animation/delay promise resolves
        if (!is_playing) break; 
        
        currentSceneIndex = i; 
        renderList(); // Update active state during playback
    }
    
    // 3. Final Reset (only if the loop finished or was broken)
    if (is_playing) {
        currentSceneIndex = 0; 
        renderList(); // Final list render to highlight Scene 1
    }

    resetPlayButton(); // Reset button appearance and state
}

// The new combined button handler
document.getElementById('btn-play-all').onclick = () => {
    if (is_playing) {
        stopPlayback();
    } else {
        startPlayback();
    }
};


  
  const messageHandler = (event) => {
    const msg = event.data.pluginMessage;
    
    if (msg.type === 'scene-captured') {
      if (msg.targetScene) {
        // This is a Play/Navigation event, msg contains the start view and the target details
        const startView = msg.view;
        const targetView = msg.targetScene;
        const pathSettingsIndex = msg.pathSettingsIndex;
        
        const pathScene = scenes[pathSettingsIndex];
        
        const customControlPoint = pathScene ? pathScene.customControlPoint : null;
        const duration = pathScene.duration;
        const easing = pathScene.easing;
        const delay = pathScene.delay;
        const bezier = pathScene.bezier;
        
        let activeControlPoint = customControlPoint;

        // Ensure default control point respects segment direction
        if (!activeControlPoint && isArcEnabled && pathScene) {
             const segmentStartIndex = pathSettingsIndex;
             const segmentEndIndex = (pathSettingsIndex + 1) % scenes.length;
             
             // We need to find the scenes corresponding to these indices to get their views
             const segStart = scenes[segmentStartIndex].view;
             const segEnd = scenes[segmentEndIndex].view;
             
             const defaultControl = calculateArcControlPoint(segStart, segEnd);
             activeControlPoint = { x: defaultControl.xc, y: defaultControl.yc };
        }
        
        animate(startView, targetView.view, duration, easing, delay, bezier, activeControlPoint);
        targetViewPayload = null;
        
      } else if (msg.updateIndex !== undefined) {
          // This is an Update Scene event
          const index = msg.updateIndex;
          if (scenes[index]) {
              scenes[index].view = msg.view;
              saveProject();
              // Optional: Visual feedback?
              // renderList(); // Not strictly necessary if we just updated data, but good to ensure consistency
              // Maybe flash the item?
              const item = document.getElementById(`name-${index}`).closest('.scene-item');
              if (item) {
                  item.style.backgroundColor = '#30b050'; // Flash green
                  setTimeout(() => {
                      item.style.backgroundColor = ''; // Revert to CSS default (or remove inline style)
                  }, 300);
              }
          }
      } else {
        // This is a Capture Scene event (no targetScene in the message)
        const newScene = {
          id: Date.now(),
          name: `Scene ${scenes.length + 1}`,
          view: msg.view,
          duration: 2000, 
          easing: 'smooth',  
          delay: 500,
          bezier: "0.24, 0.61, 0.48, 1.0",
          customControlPoint: null 
        };
        scenes.push(newScene);
        currentSceneIndex = scenes.length - 1; 
        renderList();
        saveProject(); 
        setPluginView('scenes', true); // Ensure expanded view after adding the first scene
      }
    } else if (msg.type === 'load-data') {
        initializeData(msg.data, msg.projectName);
    } else if (msg.type === 'control-point-updated') {
        if (msg.point) {
            const index = msg.sceneIndex;
            scenes[index].customControlPoint = msg.point;
            
            handleVisualizePath(index);
            
            saveProject();
            renderList(); 
        } else {
            alert("Control Point marker not found. Please click 'Visualize Path' first to place the marker on the canvas.");
        }
    }
  };
  window.onmessage = messageHandler;

function animate(start, end, duration, easing, delay, bezierString, customControlPoint, checkStop = false) {
    return new Promise(resolve => {
      const startTime = performance.now();
      
      if (duration === 0) duration = 1; 
      
      const bezierPoints = parseBezierString(bezierString);
      
      let control = null;
      if (isArcEnabled) {
          if (customControlPoint) {
              control = { xc: customControlPoint.x, yc: customControlPoint.y };
          } else {
              control = calculateArcControlPoint(start, end); 
          }
      }

      // Track last sent values to avoid redundant updates
      let lastSentX = null;
      let lastSentY = null;
      let lastSentZoom = null;
      
      // Smoothed values for dampened movement
      let smoothX = start.x;
      let smoothY = start.y;
      let smoothZoom = start.zoom;
      
      // Smoothing factor (0.0-1.0): higher = more responsive/accurate
      // 0.9 gives accurate path tracking with minimal jitter filtering
      const SMOOTHING = 0.9;
      
      // Lower threshold for more responsive but smooth updates
      const POSITION_THRESHOLD = 0.25;
      const ZOOM_THRESHOLD = 0.0002;

      function loop() {
        if (checkStop && !is_playing && animation_frame_id) {
            cancelAnimationFrame(animation_frame_id);
            return resolve(true);
        }

        const now = performance.now();
        const rawProgress = Math.min((now - startTime) / duration, 1);
        
        const easedProgress = getEasing(rawProgress, easing, bezierPoints); 

        // Clamp eased progress to prevent overshoot artifacts
        const clampedProgress = Math.max(0, Math.min(1, easedProgress));

        const currentZoom = start.zoom + (end.zoom - start.zoom) * clampedProgress;
        
        let currentX, currentY;

        if (isArcEnabled && control) { 
            const t = clampedProgress;
            const oneMinusT = 1 - t;
            
            // Quadratic Bezier Interpolation
            currentX = oneMinusT * oneMinusT * start.x + 2 * oneMinusT * t * control.xc + t * t * end.x;
            currentY = oneMinusT * oneMinusT * start.y + 2 * oneMinusT * t * control.yc + t * t * end.y;

        } else {
            // Linear interpolation
            currentX = start.x + (end.x - start.x) * clampedProgress;
            currentY = start.y + (end.y - start.y) * clampedProgress;
        }

        // Apply exponential smoothing to dampen sudden changes
        smoothX += (currentX - smoothX) * SMOOTHING;
        smoothY += (currentY - smoothY) * SMOOTHING;
        smoothZoom += (currentZoom - smoothZoom) * SMOOTHING;

        // Only send update if smoothed values changed significantly
        const xChanged = lastSentX === null || Math.abs(smoothX - lastSentX) > POSITION_THRESHOLD;
        const yChanged = lastSentY === null || Math.abs(smoothY - lastSentY) > POSITION_THRESHOLD;
        const zoomChanged = lastSentZoom === null || Math.abs(smoothZoom - lastSentZoom) > ZOOM_THRESHOLD;
        
        if (xChanged || yChanged || zoomChanged) {
            parent.postMessage({ pluginMessage: { type: 'update-viewport', x: smoothX, y: smoothY, zoom: smoothZoom } }, '*');
            lastSentX = smoothX;
            lastSentY = smoothY;
            lastSentZoom = smoothZoom;
        }

        if (rawProgress < 1) {
          animation_frame_id = requestAnimationFrame(loop);
        } else {
          // Ensure final position is exactly the end point
          parent.postMessage({ pluginMessage: { type: 'update-viewport', x: end.x, y: end.y, zoom: end.zoom } }, '*');
          // Animation finished, use setTimeout to handle the delay
          setTimeout(resolve, delay);
        }
      }
      
      // Start the loop
      animation_frame_id = requestAnimationFrame(loop); 
    });
}
</script>
</html>